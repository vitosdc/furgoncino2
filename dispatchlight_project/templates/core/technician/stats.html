<!-- templates/core/technician/stats.html -->{% extends 'base.html' %}{% block title %}Le Mie Statistiche - DispatchLight{% endblock %}{% block extra_css %}<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><style>    .stat-card {        transition: transform 0.2s ease-in-out;        border-left: 4px solid #007bff;    }    .stat-card:hover {        transform: translateY(-2px);        box-shadow: 0 4px 15px rgba(0,0,0,0.1);    }    .chart-container {        position: relative;        height: 300px;        margin: 20px 0;    }    .performance-indicator {        padding: 15px;        border-radius: 10px;        text-align: center;        margin-bottom: 20px;    }    .performance-excellent {        background: linear-gradient(135deg, #d4edda, #c3e6cb);        border: 1px solid #28a745;    }    .performance-good {        background: linear-gradient(135deg, #fff3cd, #ffeeba);        border: 1px solid #ffc107;    }    .performance-improving {        background: linear-gradient(135deg, #cce5ff, #b8daff);        border: 1px solid #007bff;    }    .metric-comparison {        display: flex;        align-items: center;        justify-content: space-between;        padding: 10px 0;        border-bottom: 1px solid #eee;    }    .metric-comparison:last-child {        border-bottom: none;    }    .trend-up { color: #28a745; }    .trend-down { color: #dc3545; }    .trend-stable { color: #6c757d; }</style>{% endblock %}{% block content %}<div class="row">    <div class="col-12">        <div class="d-flex justify-content-between align-items-center mb-4">            <div>                <h1><i class="fas fa-chart-bar"></i> Le Mie Statistiche</h1>                <p class="text-muted">{{ technician.user.get_full_name }} • Periodo: {{ period_days }} giorni</p>            </div>            <div class="btn-group">                <a href="?days=7" class="btn {% if period_days == 7 %}btn-primary{% else %}btn-outline-primary{% endif %}">7gg</a>                <a href="?days=30" class="btn {% if period_days == 30 %}btn-primary{% else %}btn-outline-primary{% endif %}">30gg</a>                <a href="?days=90" class="btn {% if period_days == 90 %}btn-primary{% else %}btn-outline-primary{% endif %}">90gg</a>                <a href="{% url 'core:technician_dashboard' %}" class="btn btn-outline-secondary">Dashboard</a>            </div>        </div>    </div></div><!-- Performance Indicator --><div class="row mb-4">    <div class="col-12">        {% if completion_rate >= 80 %}        <div class="performance-indicator performance-excellent">            <h4><i class="fas fa-trophy text-success"></i> Performance Eccellente!</h4>            <p class="mb-0">Stai facendo un ottimo lavoro con un tasso di completamento del {{ completion_rate }}%</p>        </div>        {% elif completion_rate >= 60 %}        <div class="performance-indicator performance-good">            <h4><i class="fas fa-thumbs-up text-warning"></i> Buona Performance</h4>            <p class="mb-0">Stai andando bene! Tasso di completamento: {{ completion_rate }}%</p>        </div>        {% else %}        <div class="performance-indicator performance-improving">            <h4><i class="fas fa-chart-line text-primary"></i> In Miglioramento</h4>            <p class="mb-0">Continuando così raggiungerai ottimi risultati! Attuale: {{ completion_rate }}%</p>        </div>        {% endif %}    </div></div><!-- Main Statistics Cards --><div class="row mb-4">    <div class="col-lg-3 col-md-6 mb-3">        <div class="card stat-card h-100">            <div class="card-body text-center">                <i class="fas fa-clipboard-list fa-2x text-primary mb-3"></i>                <h3 class="text-primary">{{ total_orders }}</h3>                <p class="text-muted mb-0">Ordini Totali</p>                <small class="text-success">                    <i class="fas fa-arrow-up"></i> +{{ total_orders|default:0 }} dal periodo precedente                </small>            </div>        </div>    </div>        <div class="col-lg-3 col-md-6 mb-3">        <div class="card stat-card h-100">            <div class="card-body text-center">                <i class="fas fa-check-circle fa-2x text-success mb-3"></i>                <h3 class="text-success">{{ completed_orders }}</h3>                <p class="text-muted mb-0">Completati</p>                <small class="text-success">                    {{ completion_rate }}% di successo                </small>            </div>        </div>    </div>        <div class="col-lg-3 col-md-6 mb-3">        <div class="card stat-card h-100">            <div class="card-body text-center">                <i class="fas fa-clock fa-2x text-info mb-3"></i>                <h3 class="text-info">{{ pending_orders }}</h3>                <p class="text-muted mb-0">In Attesa</p>                <small class="text-warning">                    <i class="fas fa-hourglass-half"></i> Da completare                </small>            </div>        </div>    </div>        <div class="col-lg-3 col-md-6 mb-3">        <div class="card stat-card h-100">            <div class="card-body text-center">                <i class="fas fa-euro-sign fa-2x text-warning mb-3"></i>                <h3 class="text-warning">€{{ total_revenue|floatformat:0 }}</h3>                <p class="text-muted mb-0">Fatturato</p>                <small class="text-info">                    €{{ avg_order_value|floatformat:0 }} in media                </small>            </div>        </div>    </div></div><!-- Charts Row --><div class="row mb-4">    <!-- Daily Performance Chart -->    <div class="col-lg-8">        <div class="card">            <div class="card-header">                <h5><i class="fas fa-line-chart"></i> Andamento Giornaliero</h5>            </div>            <div class="card-body">                <div class="chart-container">                    <canvas id="dailyChart"></canvas>                </div>            </div>        </div>    </div>        <!-- Priority Distribution -->    <div class="col-lg-4">        <div class="card">            <div class="card-header">                <h5><i class="fas fa-chart-pie"></i> Priorità Ordini</h5>            </div>            <div class="card-body">                <div class="chart-container">                    <canvas id="priorityChart"></canvas>                </div>            </div>        </div>    </div></div><!-- Detailed Metrics and Comparison --><div class="row">    <!-- Performance Metrics -->    <div class="col-lg-6">        <div class="card">            <div class="card-header bg-primary text-white">                <h5><i class="fas fa-tachometer-alt"></i> Metriche Performance</h5>            </div>            <div class="card-body">                <div class="metric-comparison">                    <div>                        <strong>Tasso di Completamento</strong>                        <br><small class="text-muted">Ordini completati vs totali</small>                    </div>                    <div class="text-end">                        <h5 class="{% if completion_rate >= 80 %}text-success{% elif completion_rate >= 60 %}text-warning{% else %}text-info{% endif %}">                            {{ completion_rate }}%                        </h5>                        <div class="progress" style="width: 100px; height: 8px;">                            <div class="progress-bar bg-success" style="width: {{ completion_rate }}%"></div>                        </div>                    </div>                </div>                                <div class="metric-comparison">                    <div>                        <strong>Ordini Medi al Giorno</strong>                        <br><small class="text-muted">Basato su {{ period_days }} giorni</small>                    </div>                    <div class="text-end">                        <h5 class="text-primary">{{ total_orders|default:0|floatformat:1 }}</h5>                        <small class="text-success"><i class="fas fa-arrow-up"></i> Trend positivo</small>                    </div>                </div>                                <div class="metric-comparison">                    <div>                        <strong>Valore Medio Ordine</strong>                        <br><small class="text-muted">Fatturato per intervento</small>                    </div>                    <div class="text-end">                        <h5 class="text-warning">€{{ avg_order_value|default:0|floatformat:0 }}</h5>                        <small class="text-info">Sopra la media</small>                    </div>                </div>                                <div class="metric-comparison">                    <div>                        <strong>Ordini Annullati</strong>                        <br><small class="text-muted">Non completati</small>                    </div>                    <div class="text-end">                        <h5 class="text-danger">{{ cancelled_orders|default:0 }}</h5>                        <small class="text-muted">{{ cancelled_orders|default:0 }}% del totale</small>                    </div>                </div>            </div>        </div>    </div>        <!-- Comparison with Previous Period -->    <div class="col-lg-6">        <div class="card">            <div class="card-header bg-info text-white">                <h5><i class="fas fa-balance-scale"></i> Confronto Periodi</h5>            </div>            <div class="card-body">                <h6>Periodo Attuale vs Precedente</h6>                                <div class="metric-comparison">                    <div>                        <strong>Ordini Totali</strong>                    </div>                    <div class="text-end">                        <span class="text-primary">{{ total_orders }}</span>                        <i class="fas fa-arrow-right mx-2"></i>                        <span class="text-muted">{{ previous_period_stats.total_orders|default:0 }}</span>                        {% if total_orders > previous_period_stats.total_orders|default:0 %}                            <br><small class="trend-up"><i class="fas fa-arrow-up"></i> Migliorato</small>                        {% elif total_orders < previous_period_stats.total_orders|default:0 %}                            <br><small class="trend-down"><i class="fas fa-arrow-down"></i> Diminuito</small>                        {% else %}                            <br><small class="trend-stable"><i class="fas fa-arrow-right"></i> Stabile</small>                        {% endif %}                    </div>                </div>                                <div class="metric-comparison">                    <div>                        <strong>Ordini Completati</strong>                    </div>                    <div class="text-end">                        <span class="text-success">{{ completed_orders }}</span>                        <i class="fas fa-arrow-right mx-2"></i>                        <span class="text-muted">{{ previous_period_stats.completed_orders|default:0 }}</span>                        {% if completed_orders > previous_period_stats.completed_orders|default:0 %}                            <br><small class="trend-up"><i class="fas fa-arrow-up"></i> Migliorato</small>                        {% elif completed_orders < previous_period_stats.completed_orders|default:0 %}                            <br><small class="trend-down"><i class="fas fa-arrow-down"></i> Diminuito</small>                        {% else %}                            <br><small class="trend-stable"><i class="fas fa-arrow-right"></i> Stabile</small>                        {% endif %}                    </div>                </div>                                <div class="metric-comparison">                    <div>                        <strong>Fatturato</strong>                    </div>                    <div class="text-end">                        <span class="text-warning">€{{ total_revenue|default:0|floatformat:0 }}</span>                        <i class="fas fa-arrow-right mx-2"></i>                        <span class="text-muted">€{{ previous_period_stats.total_revenue|default:0|floatformat:0 }}</span>                        {% if total_revenue > previous_period_stats.total_revenue|default:0 %}                            <br><small class="trend-up"><i class="fas fa-arrow-up"></i> Cresciuto</small>                        {% elif total_revenue < previous_period_stats.total_revenue|default:0 %}                            <br><small class="trend-down"><i class="fas fa-arrow-down"></i> Diminuito</small>                        {% else %}                            <br><small class="trend-stable"><i class="fas fa-arrow-right"></i> Stabile</small>                        {% endif %}                    </div>                </div>                                <div class="alert alert-light mt-3">                    <i class="fas fa-info-circle text-info"></i>                    <strong>Obiettivo:</strong> Mantenere un tasso di completamento > 80% e incrementare il valore medio degli ordini.                </div>            </div>        </div>    </div></div><!-- Tips and Motivation --><div class="row mt-4">    <div class="col-12">        <div class="card bg-light">            <div class="card-header">                <h5><i class="fas fa-lightbulb text-warning"></i> Suggerimenti per Migliorare</h5>            </div>            <div class="card-body">                <div class="row">                    <div class="col-md-4">                        <h6><i class="fas fa-target text-success"></i> Efficienza</h6>                        <ul class="small">                            <li>Pianifica i percorsi per ottimizzare i tempi</li>                            <li>Tieni sempre l'attrezzatura pronta</li>                            <li>Aggiorna lo stato degli ordini in tempo reale</li>                        </ul>                    </div>                    <div class="col-md-4">                        <h6><i class="fas fa-handshake text-primary"></i> Qualità Servizio</h6>                        <ul class="small">                            <li>Comunica chiaramente con i clienti</li>                            <li>Documenta bene il lavoro svolto</li>                            <li>Proponi soluzioni preventive</li>                        </ul>                    </div>                    <div class="col-md-4">                        <h6><i class="fas fa-chart-line text-info"></i> Crescita</h6>                        <ul class="small">                            <li>Analizza le tue statistiche regolarmente</li>                            <li>Chiedi feedback ai clienti</li>                            <li>Continua a formarti e aggiornarti</li>                        </ul>                    </div>                </div>            </div>        </div>    </div></div><script>document.addEventListener('DOMContentLoaded', function() {    // Daily Performance Chart    const dailyCtx = document.getElementById('dailyChart').getContext('2d');    const dailyData = {{ daily_stats|safe }};        new Chart(dailyCtx, {        type: 'line',        data: {            labels: dailyData.map(item => {                const date = new Date(item.date);                return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });            }),            datasets: [{                label: 'Ordini del Giorno',                data: dailyData.map(item => item.orders),                borderColor: 'rgb(75, 192, 192)',                backgroundColor: 'rgba(75, 192, 192, 0.1)',                tension: 0.4,                fill: true            }]        },        options: {            responsive: true,            maintainAspectRatio: false,            scales: {                y: {                    beginAtZero: true,                    ticks: {                        stepSize: 1                    }                }            },            plugins: {                legend: {                    display: false                },                tooltip: {                    callbacks: {                        label: function(context) {                            return `${context.parsed.y} ordini`;                        }                    }                }            }        }    });        // Priority Distribution Chart    const priorityCtx = document.getElementById('priorityChart').getContext('2d');    const priorityData = {{ priority_stats|safe }};        new Chart(priorityCtx, {        type: 'doughnut',        data: {            labels: priorityData.map(item => {                const labels = {                    'URGENT': 'Urgente',                    'HIGH': 'Alta',                    'NORMAL': 'Normale',                    'LOW': 'Bassa'                };                return labels[item.priority] || item.priority;            }),            datasets: [{                data: priorityData.map(item => item.count),                backgroundColor: [                    'rgba(220, 53, 69, 0.8)',  // Urgente - Rosso                    'rgba(253, 126, 20, 0.8)', // Alta - Arancione                      'rgba(0, 123, 255, 0.8)',  // Normale - Blu                    'rgba(108, 117, 125, 0.8)' // Bassa - Grigio                ],                borderColor: [                    'rgba(220, 53, 69, 1)',                    'rgba(253, 126, 20, 1)',                    'rgba(0, 123, 255, 1)',                    'rgba(108, 117, 125, 1)'                ],                borderWidth: 2            }]        },        options: {            responsive: true,            maintainAspectRatio: false,            plugins: {                legend: {                    position: 'bottom',                },                tooltip: {                    callbacks: {                        label: function(context) {                            const total = context.dataset.data.reduce((sum, val) => sum + val, 0);                            const percentage = ((context.parsed / total) * 100).toFixed(1);                            return `${context.label}: ${context.parsed} (${percentage}%)`;                        }                    }                }            }        }    });});</script>{% endblock %}