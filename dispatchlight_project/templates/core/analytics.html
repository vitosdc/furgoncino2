<!-- templates/core/analytics.html -->{% extends 'base.html' %}{% block title %}Analytics Dashboard - DispatchLight{% endblock %}{% block extra_css %}<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><style>    .metric-card {        border-left: 4px solid #007bff;        transition: transform 0.2s;    }    .metric-card:hover {        transform: translateY(-2px);        box-shadow: 0 4px 8px rgba(0,0,0,0.1);    }    .chart-container {        position: relative;        height: 400px;        margin-bottom: 2rem;    }    .small-chart {        height: 250px;    }    .analytics-header {        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);        color: white;        padding: 2rem 0;        margin-bottom: 2rem;    }</style>{% endblock %}{% block content %}<!-- Analytics Header --><div class="analytics-header">    <div class="container">        <div class="row align-items-center">            <div class="col-md-8">                <h1><i class="fas fa-chart-line"></i> Analytics Dashboard</h1>                <p class="lead mb-0">Insights dettagliati sulle performance della tua azienda</p>            </div>            <div class="col-md-4 text-end">                <div class="btn-group" role="group">                    <a href="{% url 'core:reports' %}" class="btn btn-light">                        <i class="fas fa-file-alt"></i> Report Dettagliati                    </a>                    <button class="btn btn-outline-light" onclick="exportData()">                        <i class="fas fa-download"></i> Esporta                    </button>                </div>            </div>        </div>    </div></div><div class="container">    <!-- Overview Metrics -->    <div class="row g-4 mb-5">        <div class="col-md-3">            <div class="card metric-card h-100">                <div class="card-body text-center">                    <i class="fas fa-clipboard-list fa-2x text-primary mb-3"></i>                    <h3 class="mb-1">{{ overview_stats.total_orders }}</h3>                    <p class="text-muted mb-0">Ordini Totali</p>                    <small class="text-success">                        <i class="fas fa-arrow-up"></i>                         {{ overview_stats.completed_orders }} completati                    </small>                </div>            </div>        </div>                <div class="col-md-3">            <div class="card metric-card h-100">                <div class="card-body text-center">                    <i class="fas fa-euro-sign fa-2x text-success mb-3"></i>                    <h3 class="mb-1">€{{ overview_stats.total_revenue|floatformat:0 }}</h3>                    <p class="text-muted mb-0">Fatturato Totale</p>                    <small class="text-info">                        <i class="fas fa-chart-line"></i>                         Trend positivo                    </small>                </div>            </div>        </div>                <div class="col-md-3">            <div class="card metric-card h-100">                <div class="card-body text-center">                    <i class="fas fa-users fa-2x text-info mb-3"></i>                    <h3 class="mb-1">{{ overview_stats.active_customers }}</h3>                    <p class="text-muted mb-0">Clienti Attivi</p>                    <small class="text-primary">                        <i class="fas fa-user-plus"></i>                         Base clienti                    </small>                </div>            </div>        </div>                <div class="col-md-3">            <div class="card metric-card h-100">                <div class="card-body text-center">                    <i class="fas fa-user-cog fa-2x text-warning mb-3"></i>                    <h3 class="mb-1">{{ overview_stats.active_technicians }}</h3>                    <p class="text-muted mb-0">Tecnici Attivi</p>                    <small class="text-success">                        <i class="fas fa-check-circle"></i>                         Operativi                    </small>                </div>            </div>        </div>    </div>    <!-- Financial Summary -->    <div class="row mb-5">        <div class="col-12">            <div class="card">                <div class="card-header d-flex justify-content-between align-items-center">                    <h5><i class="fas fa-chart-bar"></i> Riepilogo Finanziario (Ultimi 30 giorni)</h5>                    <div class="btn-group btn-group-sm">                        <button class="btn btn-outline-primary active" onclick="changePeriod(30)">30gg</button>                        <button class="btn btn-outline-primary" onclick="changePeriod(90)">90gg</button>                        <button class="btn btn-outline-primary" onclick="changePeriod(365)">1 anno</button>                    </div>                </div>                <div class="card-body">                    <div class="row">                        <div class="col-md-3">                            <div class="text-center">                                <h4 class="text-success">€{{ financial_summary.current_revenue|floatformat:0 }}</h4>                                <p class="text-muted">Fatturato Corrente</p>                                {% if financial_summary.revenue_change > 0 %}                                    <span class="badge bg-success">+{{ financial_summary.revenue_change }}%</span>                                {% elif financial_summary.revenue_change < 0 %}                                    <span class="badge bg-danger">{{ financial_summary.revenue_change }}%</span>                                {% else %}                                    <span class="badge bg-secondary">{{ financial_summary.revenue_change }}%</span>                                {% endif %}                            </div>                        </div>                        <div class="col-md-3">                            <div class="text-center">                                <h4 class="text-danger">€{{ financial_summary.current_expenses|floatformat:0 }}</h4>                                <p class="text-muted">Spese Sostenute</p>                                <span class="badge bg-info">Controllate</span>                            </div>                        </div>                        <div class="col-md-3">                            <div class="text-center">                                <h4 class="text-primary">€{{ financial_summary.net_profit|floatformat:0 }}</h4>                                <p class="text-muted">Profitto Netto</p>                                {% if financial_summary.net_profit > 0 %}                                    <span class="badge bg-success">Positivo</span>                                {% else %}                                    <span class="badge bg-warning">In crescita</span>                                {% endif %}                            </div>                        </div>                        <div class="col-md-3">                            <div class="text-center">                                <h4 class="text-info">€{{ financial_summary.avg_order_value|floatformat:0 }}</h4>                                <p class="text-muted">Valore Medio Ordine</p>                                <span class="badge bg-primary">Per intervento</span>                            </div>                        </div>                    </div>                </div>            </div>        </div>    </div>    <!-- Charts Row -->    <div class="row g-4 mb-5">        <!-- Monthly Performance Chart -->        <div class="col-lg-8">            <div class="card">                <div class="card-header">                    <h5><i class="fas fa-line-chart"></i> Performance Mensile</h5>                </div>                <div class="card-body">                    <div class="chart-container">                        <canvas id="monthlyChart"></canvas>                    </div>                </div>            </div>        </div>                <!-- Status Distribution -->        <div class="col-lg-4">            <div class="card">                <div class="card-header">                    <h5><i class="fas fa-pie-chart"></i> Stati Ordini</h5>                </div>                <div class="card-body">                    <div class="chart-container small-chart">                        <canvas id="statusChart"></canvas>                    </div>                </div>            </div>        </div>    </div>    <!-- Second Charts Row -->    <div class="row g-4 mb-5">        <!-- Technician Performance -->        <div class="col-lg-6">            <div class="card">                <div class="card-header">                    <h5><i class="fas fa-users-cog"></i> Performance Tecnici</h5>                </div>                <div class="card-body">                    <div class="chart-container small-chart">                        <canvas id="technicianChart"></canvas>                    </div>                </div>            </div>        </div>                <!-- Weekly Schedule -->        <div class="col-lg-6">            <div class="card">                <div class="card-header">                    <h5><i class="fas fa-calendar-week"></i> Distribuzione Settimanale</h5>                </div>                <div class="card-body">                    <div class="chart-container small-chart">                        <canvas id="weeklyChart"></canvas>                    </div>                </div>            </div>        </div>    </div>    <!-- Service Types Analysis -->    {% if service_type_analysis %}    <div class="row mb-5">        <div class="col-12">            <div class="card">                <div class="card-header">                    <h5><i class="fas fa-cogs"></i> Analisi Tipi di Servizio</h5>                </div>                <div class="card-body">                    <div class="table-responsive">                        <table class="table table-hover">                            <thead>                                <tr>                                    <th>Tipo Servizio</th>                                    <th>Ordini</th>                                    <th>Fatturato Totale</th>                                    <th>Prezzo Medio</th>                                    <th>Performance</th>                                </tr>                            </thead>                            <tbody>                                {% for service in service_type_analysis %}                                <tr>                                    <td><strong>{{ service.service_name }}</strong></td>                                    <td>                                        <span class="badge bg-primary">{{ service.count }}</span>                                    </td>                                    <td>€{{ service.total_revenue|floatformat:0 }}</td>                                    <td>€{{ service.avg_price|floatformat:0 }}</td>                                    <td>                                        <div class="progress" style="height: 20px;">                                            <div class="progress-bar" style="width: {{ service.count }}%">                                                {{ service.count }}%                                            </div>                                        </div>                                    </td>                                </tr>                                {% endfor %}                            </tbody>                        </table>                    </div>                </div>            </div>        </div>    </div>    {% endif %}    <!-- Technician Performance Table -->    <div class="row">        <div class="col-12">            <div class="card">                <div class="card-header">                    <h5><i class="fas fa-trophy"></i> Classifica Tecnici</h5>                </div>                <div class="card-body">                    <div class="table-responsive">                        <table class="table table-hover">                            <thead>                                <tr>                                    <th>Posizione</th>                                    <th>Tecnico</th>                                    <th>Ordini Totali</th>                                    <th>Completati</th>                                    <th>Tasso Completamento</th>                                    <th>Fatturato</th>                                    <th>Score Efficienza</th>                                </tr>                            </thead>                            <tbody>                                {% for tech in technician_performance %}                                <tr>                                    <td>                                        {% if forloop.counter == 1 %}                                            <i class="fas fa-trophy text-warning"></i>                                        {% elif forloop.counter == 2 %}                                            <i class="fas fa-medal text-secondary"></i>                                        {% elif forloop.counter == 3 %}                                            <i class="fas fa-award text-warning"></i>                                        {% else %}                                            {{ forloop.counter }}°                                        {% endif %}                                    </td>                                    <td><strong>{{ tech.name }}</strong></td>                                    <td>{{ tech.total_orders }}</td>                                    <td>{{ tech.completed_orders }}</td>                                    <td>                                        <div class="d-flex align-items-center">                                            <div class="progress me-2" style="width: 60px; height: 8px;">                                                <div class="progress-bar bg-success" style="width: {{ tech.completion_rate }}%"></div>                                            </div>                                            {{ tech.completion_rate }}%                                        </div>                                    </td>                                    <td>€{{ tech.total_revenue|floatformat:0 }}</td>                                    <td>                                        <span class="badge {% if tech.efficiency_score >= 80 %}bg-success{% elif tech.efficiency_score >= 60 %}bg-warning{% else %}bg-secondary{% endif %}">                                            {{ tech.efficiency_score }}                                        </span>                                    </td>                                </tr>                                {% endfor %}                            </tbody>                        </table>                    </div>                </div>            </div>        </div>    </div></div><script>// Dati per i graficiconst monthlyData = {{ monthly_performance|safe }};const statusData = {{ status_distribution|safe }};const technicianData = {{ technician_performance|safe }};const weeklyData = {{ weekly_schedule|safe }};// Monthly Performance Chartconst monthlyCtx = document.getElementById('monthlyChart').getContext('2d');new Chart(monthlyCtx, {    type: 'line',    data: {        labels: monthlyData.map(item => item.month_year),        datasets: [{            label: 'Ordini Creati',            data: monthlyData.map(item => item.orders_count),            borderColor: 'rgb(75, 192, 192)',            backgroundColor: 'rgba(75, 192, 192, 0.1)',            tension: 0.4,            yAxisID: 'y'        }, {            label: 'Ordini Completati',            data: monthlyData.map(item => item.completed_count),            borderColor: 'rgb(54, 162, 235)',            backgroundColor: 'rgba(54, 162, 235, 0.1)',            tension: 0.4,            yAxisID: 'y'        }, {            label: 'Fatturato (€)',            data: monthlyData.map(item => item.revenue),            borderColor: 'rgb(255, 99, 132)',            backgroundColor: 'rgba(255, 99, 132, 0.1)',            tension: 0.4,            yAxisID: 'y1'        }]    },    options: {        responsive: true,        maintainAspectRatio: false,        interaction: {            mode: 'index',            intersect: false,        },        scales: {            x: {                display: true,                title: {                    display: true,                    text: 'Mese'                }            },            y: {                type: 'linear',                display: true,                position: 'left',                title: {                    display: true,                    text: 'Numero Ordini'                }            },            y1: {                type: 'linear',                display: true,                position: 'right',                title: {                    display: true,                    text: 'Fatturato (€)'                },                grid: {                    drawOnChartArea: false,                },            }        },        plugins: {            legend: {                position: 'top',            },            title: {                display: true,                text: 'Trend Performance Mensile'            }        }    }});// Status Distribution Chartconst statusCtx = document.getElementById('statusChart').getContext('2d');const totalOrders = statusData.reduce((sum, item) => sum + item.count, 0);new Chart(statusCtx, {    type: 'doughnut',    data: {        labels: statusData.map(item => item.status),        datasets: [{            data: statusData.map(item => item.count),            backgroundColor: [                'rgba(255, 99, 132, 0.8)',                'rgba(54, 162, 235, 0.8)',                'rgba(255, 205, 86, 0.8)',                'rgba(75, 192, 192, 0.8)',                'rgba(153, 102, 255, 0.8)',                'rgba(255, 159, 64, 0.8)'            ],            borderColor: [                'rgba(255, 99, 132, 1)',                'rgba(54, 162, 235, 1)',                'rgba(255, 205, 86, 1)',                'rgba(75, 192, 192, 1)',                'rgba(153, 102, 255, 1)',                'rgba(255, 159, 64, 1)'            ],            borderWidth: 2        }]    },    options: {        responsive: true,        maintainAspectRatio: false,        plugins: {            legend: {                position: 'bottom',            },            title: {                display: true,                text: 'Distribuzione Stati Ordini'            },            tooltip: {                callbacks: {                    label: function(context) {                        const percentage = ((context.parsed / totalOrders) * 100).toFixed(1);                        return context.label + ': ' + context.parsed + ' (' + percentage + '%)';                    }                }            }        }    }});// Technician Performance Chartconst techCtx = document.getElementById('technicianChart').getContext('2d');new Chart(techCtx, {    type: 'bar',    data: {        labels: technicianData.map(item => item.name),        datasets: [{            label: 'Score Efficienza',            data: technicianData.map(item => item.efficiency_score),            backgroundColor: 'rgba(54, 162, 235, 0.6)',            borderColor: 'rgba(54, 162, 235, 1)',            borderWidth: 1        }, {            label: 'Tasso Completamento (%)',            data: technicianData.map(item => item.completion_rate),            backgroundColor: 'rgba(75, 192, 192, 0.6)',            borderColor: 'rgba(75, 192, 192, 1)',            borderWidth: 1        }]    },    options: {        responsive: true,        maintainAspectRatio: false,        scales: {            y: {                beginAtZero: true,                max: 100,                title: {                    display: true,                    text: 'Percentuale'                }            }        },        plugins: {            legend: {                position: 'top',            },            title: {                display: true,                text: 'Performance Tecnici'            }        }    }});// Weekly Schedule Chartconst weeklyCtx = document.getElementById('weeklyChart').getContext('2d');new Chart(weeklyCtx, {    type: 'bar',    data: {        labels: weeklyData.map(item => item.day),        datasets: [{            label: 'Ordini per Giorno',            data: weeklyData.map(item => item.count),            backgroundColor: [                'rgba(255, 99, 132, 0.6)',                'rgba(54, 162, 235, 0.6)',                'rgba(255, 205, 86, 0.6)',                'rgba(75, 192, 192, 0.6)',                'rgba(153, 102, 255, 0.6)',                'rgba(255, 159, 64, 0.6)',                'rgba(199, 199, 199, 0.6)'            ],            borderColor: [                'rgba(255, 99, 132, 1)',                'rgba(54, 162, 235, 1)',                'rgba(255, 205, 86, 1)',                'rgba(75, 192, 192, 1)',                'rgba(153, 102, 255, 1)',                'rgba(255, 159, 64, 1)',                'rgba(199, 199, 199, 1)'            ],            borderWidth: 1        }]    },    options: {        responsive: true,        maintainAspectRatio: false,        scales: {            y: {                beginAtZero: true,                title: {                    display: true,                    text: 'Numero Ordini'                }            }        },        plugins: {            legend: {                display: false            },            title: {                display: true,                text: 'Distribuzione Ordini per Giorno Settimana'            }        }    }});// Utility functionsfunction changePeriod(days) {    window.location.href = `?period=${days}`;}function exportData() {    // Implementazione futura per export PDF/Excel    alert('Funzionalità di export in sviluppo!');}// Auto-refresh ogni 5 minutisetTimeout(() => {    location.reload();}, 300000);</script>{% endblock %}