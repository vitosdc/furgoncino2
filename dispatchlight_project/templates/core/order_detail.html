<!-- templates/core/order_detail.html -->{% extends 'base.html' %}{% block title %}Ordine {{ order.order_number }} - DispatchLight{% endblock %}{% block content %}<div class="row">    <div class="col-12">        <div class="d-flex justify-content-between align-items-center mb-4">            <h1><i class="fas fa-clipboard-list"></i> Ordine {{ order.order_number }}</h1>            <div>                <a href="{% url 'core:order_edit' order.pk %}" class="btn btn-outline-warning">                    <i class="fas fa-edit"></i> Modifica                </a>                <a href="{% url 'core:order_list' %}" class="btn btn-outline-secondary">                    <i class="fas fa-arrow-left"></i> Torna alla Lista                </a>            </div>        </div>    </div></div><div class="row">    <div class="col-lg-8">        <div class="card mb-4">            <div class="card-header">                <h5><i class="fas fa-info-circle"></i> Dettagli Ordine</h5>            </div>            <div class="card-body">                <dl class="row">                    <dt class="col-sm-3">Titolo:</dt>                    <dd class="col-sm-9"><strong>{{ order.title }}</strong></dd>                                        <dt class="col-sm-3">Cliente:</dt>                    <dd class="col-sm-9">                        <a href="{% url 'core:customer_detail' order.customer.pk %}">{{ order.customer.name }}</a>                        <br><small class="text-muted">{{ order.customer.phone }}</small>                    </dd>                                        <dt class="col-sm-3">Descrizione:</dt>                    <dd class="col-sm-9">{{ order.description }}</dd>                                        <dt class="col-sm-3">Indirizzo:</dt>                    <dd class="col-sm-9">                        {{ order.service_address }}                        <a href="https://maps.google.com/?q={{ order.service_address }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">                            <i class="fas fa-map-marked-alt"></i> Mappa                        </a>                    </dd>                                        <dt class="col-sm-3">Stato:</dt>                    <dd class="col-sm-9">                        {% if order.status == 'PENDING' %}                            <span class="badge bg-warning fs-6">Da Assegnare</span>                        {% elif order.status == 'ASSIGNED' %}                            <span class="badge bg-info fs-6">Assegnato</span>                        {% elif order.status == 'EN_ROUTE' %}                            <span class="badge bg-primary fs-6">In Viaggio</span>                        {% elif order.status == 'ON_SITE' %}                            <span class="badge bg-secondary fs-6">Sul Posto</span>                        {% elif order.status == 'COMPLETED' %}                            <span class="badge bg-success fs-6">Completato</span>                        {% elif order.status == 'CANCELLED' %}                            <span class="badge bg-danger fs-6">Annullato</span>                        {% endif %}                    </dd>                                        <dt class="col-sm-3">Priorità:</dt>                    <dd class="col-sm-9">                        {% if order.priority == 'URGENT' %}                            <span class="badge bg-danger">Urgente</span>                        {% elif order.priority == 'HIGH' %}                            <span class="badge bg-warning">Alta</span>                        {% elif order.priority == 'NORMAL' %}                            <span class="badge bg-info">Normale</span>                        {% elif order.priority == 'LOW' %}                            <span class="badge bg-secondary">Bassa</span>                        {% endif %}                    </dd>                                        <dt class="col-sm-3">Tecnico:</dt>                    <dd class="col-sm-9">                        {% if order.technician %}                            {{ order.technician.user.get_full_name }}                            <br><small class="text-muted">{{ order.technician.phone }}</small>                        {% else %}                            <span class="text-muted">Non assegnato</span>                            {% if order.status == 'PENDING' %}                                <a href="#" class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#assignModal">                                    <i class="fas fa-user-plus"></i> Assegna                                </a>                            {% endif %}                        {% endif %}                    </dd>                                        {% if order.service_type %}                    <dt class="col-sm-3">Tipo Servizio:</dt>                    <dd class="col-sm-9">{{ order.service_type.name }}</dd>                    {% endif %}                                        <dt class="col-sm-3">Durata Stimata:</dt>                    <dd class="col-sm-9">{{ order.estimated_duration_minutes }} minuti</dd>                                        {% if order.estimated_price %}                    <dt class="col-sm-3">Prezzo Stimato:</dt>                    <dd class="col-sm-9">€{{ order.estimated_price }}</dd>                    {% endif %}                                        {% if order.final_price %}                    <dt class="col-sm-3">Prezzo Finale:</dt>                    <dd class="col-sm-9"><strong>€{{ order.final_price }}</strong></dd>                    {% endif %}                </dl>            </div>        </div>                <!-- Timeline -->        <div class="card">            <div class="card-header">                <h5><i class="fas fa-clock"></i> Timeline Ordine</h5>            </div>            <div class="card-body">                <div class="timeline">                    <div class="timeline-item">                        <div class="timeline-marker bg-primary"></div>                        <div class="timeline-content">                            <h6>Ordine Creato</h6>                            <small class="text-muted">{{ order.created_at|date:"d/m/Y H:i" }}</small>                        </div>                    </div>                                        {% if order.assigned_at %}                    <div class="timeline-item">                        <div class="timeline-marker bg-info"></div>                        <div class="timeline-content">                            <h6>Assegnato a {{ order.technician.user.get_full_name }}</h6>                            <small class="text-muted">{{ order.assigned_at|date:"d/m/Y H:i" }}</small>                        </div>                    </div>                    {% endif %}                                        {% if order.started_at %}                    <div class="timeline-item">                        <div class="timeline-marker bg-warning"></div>                        <div class="timeline-content">                            <h6>Tecnico Arrivato sul Posto</h6>                            <small class="text-muted">{{ order.started_at|date:"d/m/Y H:i" }}</small>                        </div>                    </div>                    {% endif %}                                        {% if order.completed_at %}                    <div class="timeline-item">                        <div class="timeline-marker bg-success"></div>                        <div class="timeline-content">                            <h6>Ordine Completato</h6>                            <small class="text-muted">{{ order.completed_at|date:"d/m/Y H:i" }}</small>                        </div>                    </div>                    {% endif %}                </div>            </div>        </div>    </div>        <div class="col-lg-4">        <!-- Azioni Rapide -->        <div class="card mb-4">            <div class="card-header">                <h5><i class="fas fa-bolt"></i> Azioni Rapide</h5>            </div>            <div class="card-body">                {% if order.status == 'PENDING' %}                    <div class="d-grid gap-2">                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignModal">                            <i class="fas fa-user-plus"></i> Assegna Tecnico                        </button>                        <a href="{% url 'core:order_edit' order.pk %}" class="btn btn-outline-warning">                            <i class="fas fa-edit"></i> Modifica Ordine                        </a>                    </div>                {% elif order.status == 'ASSIGNED' %}                    <div class="alert alert-info">                        <i class="fas fa-info-circle"></i> Ordine assegnato a {{ order.technician.user.get_full_name }}. In attesa che il tecnico si metta in viaggio.                    </div>                {% elif order.status == 'COMPLETED' %}                    <div class="d-grid gap-2">                        <button class="btn btn-success" disabled>                            <i class="fas fa-check"></i> Ordine Completato                        </button>                        <button class="btn btn-outline-primary">                            <i class="fas fa-file-invoice"></i> Genera Fattura                        </button>                    </div>                {% endif %}            </div>        </div>                <!-- Note e Lavoro Svolto -->        {% if order.technician_notes or order.work_performed %}        <div class="card mb-4">            <div class="card-header">                <h5><i class="fas fa-sticky-note"></i> Note Tecnico</h5>            </div>            <div class="card-body">                {% if order.work_performed %}                    <h6>Lavoro Svolto:</h6>                    <p>{{ order.work_performed }}</p>                {% endif %}                                {% if order.technician_notes %}                    <h6>Note:</h6>                    <p>{{ order.technician_notes }}</p>                {% endif %}                                {% if order.materials_used %}                    <h6>Materiali Utilizzati:</h6>                    <p>{{ order.materials_used }}</p>                {% endif %}            </div>        </div>        {% endif %}                <!-- Spese -->        {% if expenses %}        <div class="card">            <div class="card-header">                <h5><i class="fas fa-receipt"></i> Spese Sostenute</h5>            </div>            <div class="card-body">                <div class="table-responsive">                    <table class="table table-sm">                        <thead>                            <tr>                                <th>Tipo</th>                                <th>Importo</th>                                <th>Ricevuta</th>                            </tr>                        </thead>                        <tbody>                            {% for expense in expenses %}                            <tr>                                <td>{{ expense.get_expense_type_display }}</td>                                <td>€{{ expense.amount }}</td>                                <td>                                    {% if expense.receipt_image %}                                        <a href="{{ expense.receipt_image.url }}" target="_blank" class="btn btn-sm btn-outline-primary">                                            <i class="fas fa-image"></i>                                        </a>                                    {% else %}                                        -                                    {% endif %}                                </td>                            </tr>                            {% endfor %}                        </tbody>                        <tfoot>                            <tr class="table-info">                                <th>Totale Spese:</th>                                <th>€{% widthratio expenses|length 1 1 as total %}{{ total }}</th>                                <th></th>                            </tr>                        </tfoot>                    </table>                </div>            </div>        </div>        {% endif %}    </div></div><!-- Modal Assegnazione Tecnico --><div class="modal fade" id="assignModal" tabindex="-1">    <div class="modal-dialog">        <div class="modal-content">            <div class="modal-header">                <h5 class="modal-title">Assegna Tecnico</h5>                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>            </div>            <div class="modal-body">                <p>Seleziona il tecnico a cui assegnare questo ordine:</p>                <div class="list-group">                    {% for tech in order.company.technicians.all %}                        {% if tech.is_active %}                        <a href="{% url 'core:assign_order' order.pk tech.id %}" class="list-group-item list-group-item-action">                            <div class="d-flex w-100 justify-content-between">                                <h6 class="mb-1">{{ tech.user.get_full_name }}</h6>                                <small>{{ tech.phone }}</small>                            </div>                            {% if tech.vehicle_plate %}                                <small class="text-muted">Veicolo: {{ tech.vehicle_plate }}</small>                            {% endif %}                        </a>                        {% endif %}                    {% empty %}                        <div class="alert alert-warning">                            <i class="fas fa-exclamation-triangle"></i> Nessun tecnico disponibile.                            <a href="{% url 'core:technician_create' %}">Aggiungi un tecnico</a>                        </div>                    {% endfor %}                </div>            </div>        </div>    </div></div><style>.timeline {    position: relative;    padding-left: 30px;}.timeline::before {    content: '';    position: absolute;    left: 15px;    top: 0;    bottom: 0;    width: 2px;    background: #dee2e6;}.timeline-item {    position: relative;    margin-bottom: 20px;}.timeline-marker {    position: absolute;    left: -22px;    top: 5px;    width: 12px;    height: 12px;    border-radius: 50%;    border: 2px solid white;    box-shadow: 0 0 0 2px #dee2e6;}</style>{% endblock %}