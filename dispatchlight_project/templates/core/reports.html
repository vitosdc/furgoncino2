<!-- templates/core/reports.html -->{% extends 'base.html' %}{% block title %}Report Dettagliati - DispatchLight{% endblock %}{% block extra_css %}<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><style>    .report-section {        margin-bottom: 3rem;    }    .metric-highlight {        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);        color: white;        border-radius: 10px;        padding: 1.5rem;    }    .trend-up { color: #28a745; }    .trend-down { color: #dc3545; }    .trend-neutral { color: #6c757d; }    @media print {        .no-print { display: none !important; }        .card { box-shadow: none !important; border: 1px solid #dee2e6 !important; }    }</style>{% endblock %}{% block content %}<div class="container my-4">    <!-- Header with Export Options -->    <div class="d-flex justify-content-between align-items-center mb-4 no-print">        <div>            <h1><i class="fas fa-file-alt"></i> Report Dettagliati</h1>            <p class="text-muted">Analisi approfondita delle performance aziendali</p>        </div>        <div class="btn-group">            <button class="btn btn-primary" onclick="window.print()">                <i class="fas fa-print"></i> Stampa Report            </button>            <button class="btn btn-outline-primary" onclick="exportToPDF()">                <i class="fas fa-file-pdf"></i> PDF            </button>            <button class="btn btn-outline-success" onclick="exportToExcel()">                <i class="fas fa-file-excel"></i> Excel            </button>        </div>    </div>    <!-- Period Selector -->    <div class="card mb-4 no-print">        <div class="card-body">            <h5>Seleziona Periodo di Analisi</h5>            <div class="btn-group" role="group">                <a href="?period=7" class="btn {% if period_days == 7 %}btn-primary{% else %}btn-outline-primary{% endif %}">                    Ultimi 7 giorni                </a>                <a href="?period=30" class="btn {% if period_days == 30 %}btn-primary{% else %}btn-outline-primary{% endif %}">                    Ultimi 30 giorni                </a>                <a href="?period=90" class="btn {% if period_days == 90 %}btn-primary{% else %}btn-outline-primary{% endif %}">                    Ultimi 90 giorni                </a>                <a href="?period=365" class="btn {% if period_days == 365 %}btn-primary{% else %}btn-outline-primary{% endif %}">                    Ultimo anno                </a>            </div>        </div>    </div>    <!-- Executive Summary -->    <div class="report-section">        <div class="metric-highlight mb-4">            <div class="row text-center">                <div class="col-md-3">                    <h3>€{{ financial_summary.current_revenue|floatformat:0 }}</h3>                    <p class="mb-0">Fatturato Periodo</p>                </div>                <div class="col-md-3">                    <h3>{{ financial_summary.current_orders }}</h3>                    <p class="mb-0">Ordini Completati</p>                </div>                <div class="col-md-3">                    <h3>€{{ financial_summary.avg_order_value|floatformat:0 }}</h3>                    <p class="mb-0">Valore Medio Ordine</p>                </div>                <div class="col-md-3">                    <h3>€{{ financial_summary.net_profit|floatformat:0 }}</h3>                    <p class="mb-0">Profitto Netto</p>                </div>            </div>        </div>    </div>    <!-- Financial Analysis -->    <div class="report-section">        <div class="card">            <div class="card-header">                <h4><i class="fas fa-chart-line"></i> Analisi Finanziaria</h4>            </div>            <div class="card-body">                <div class="row">                    <div class="col-md-6">                        <h6>Confronto con Periodo Precedente</h6>                        <table class="table table-sm">                            <tr>                                <td>Fatturato Corrente:</td>                                <td class="text-end"><strong>€{{ financial_summary.current_revenue|floatformat:0 }}</strong></td>                            </tr>                            <tr>                                <td>Fatturato Precedente:</td>                                <td class="text-end">€{{ financial_summary.previous_revenue|floatformat:0 }}</td>                            </tr>                            <tr>                                <td>Variazione:</td>                                <td class="text-end">                                    <span class="{% if financial_summary.revenue_change > 0 %}trend-up{% elif financial_summary.revenue_change < 0 %}trend-down{% else %}trend-neutral{% endif %}">                                        {% if financial_summary.revenue_change > 0 %}+{% endif %}{{ financial_summary.revenue_change }}%                                        <i class="fas fa-arrow-{% if financial_summary.revenue_change > 0 %}up{% elif financial_summary.revenue_change < 0 %}down{% else %}right{% endif %}"></i>                                    </span>                                </td>                            </tr>                        </table>                    </div>                    <div class="col-md-6">                        <h6>Breakdown Finanziario</h6>                        <table class="table table-sm">                            <tr>                                <td>Ricavi Lordi:</td>                                <td class="text-end text-success">€{{ financial_summary.current_revenue|floatformat:0 }}</td>                            </tr>                            <tr>                                <td>Spese Operative:</td>                                <td class="text-end text-danger">€{{ financial_summary.current_expenses|floatformat:0 }}</td>                            </tr>                            <tr class="table-info">                                <td><strong>Profitto Netto:</strong></td>                                <td class="text-end"><strong>€{{ financial_summary.net_profit|floatformat:0 }}</strong></td>                            </tr>                            <tr>                                <td>Margine Profitto:</td>                                <td class="text-end">                                    {% widthratio financial_summary.net_profit financial_summary.current_revenue 100 %}%                                </td>                            </tr>                        </table>                    </div>                </div>            </div>        </div>    </div>    <!-- Top Customers Analysis -->    <div class="report-section">        <div class="card">            <div class="card-header">                <h4><i class="fas fa-star"></i> Top 10 Clienti</h4>            </div>            <div class="card-body">                <div class="table-responsive">                    <table class="table table-hover">                        <thead>                            <tr>                                <th>Posizione</th>                                <th>Cliente</th>                                <th>Ordini Totali</th>                                <th>Spesa Totale</th>                                <th>Valore Medio Ordine</th>                                <th>Ultimo Ordine</th>                                <th>Fedeltà</th>                            </tr>                        </thead>                        <tbody>                            {% for customer in customer_analysis %}                            <tr>                                <td>                                    {% if forloop.counter <= 3 %}                                        <span class="badge bg-warning">{{ forloop.counter }}</span>                                    {% else %}                                        {{ forloop.counter }}                                    {% endif %}                                </td>                                <td><strong>{{ customer.name }}</strong></td>                                <td>{{ customer.total_orders }}</td>                                <td>€{{ customer.total_spent|floatformat:0 }}</td>                                <td>€{{ customer.avg_order_value|floatformat:0 }}</td>                                <td>{{ customer.last_order_date|date:"d/m/Y"|default:"N/A" }}</td>                                <td>                                    <div class="progress" style="height: 15px;">                                        {% widthratio customer.total_orders 10 100 as loyalty_percent %}                                        <div class="progress-bar bg-success" style="width: {% if loyalty_percent > 100 %}100{% else %}{{ loyalty_percent }}{% endif %}%">                                        </div>                                    </div>                                </td>                            </tr>                            {% endfor %}                        </tbody>                    </table>                </div>            </div>        </div>    </div>    <!-- Technician Detailed Performance -->    <div class="report-section">        <div class="card">            <div class="card-header">                <h4><i class="fas fa-users-cog"></i> Performance Dettagliata Tecnici</h4>            </div>            <div class="card-body">                <div class="row">                    {% for tech in technician_performance %}                    <div class="col-md-6 mb-4">                        <div class="card border-left-primary">                            <div class="card-header d-flex justify-content-between">                                <h6 class="mb-0">{{ tech.name }}</h6>                                <span class="badge {% if tech.efficiency_score >= 80 %}bg-success{% elif tech.efficiency_score >= 60 %}bg-warning{% else %}bg-secondary{% endif %}">                                    Score: {{ tech.efficiency_score }}                                </span>                            </div>                            <div class="card-body">                                <div class="row text-center">                                    <div class="col-6">                                        <h5 class="text-primary">{{ tech.total_orders }}</h5>                                        <small class="text-muted">Ordini Totali</small>                                    </div>                                    <div class="col-6">                                        <h5 class="text-success">{{ tech.completion_rate }}%</h5>                                        <small class="text-muted">Completamento</small>                                    </div>                                </div>                                <hr>                                <div class="row text-center">                                    <div class="col-6">                                        <h6 class="text-info">€{{ tech.total_revenue|floatformat:0 }}</h6>                                        <small class="text-muted">Fatturato</small>                                    </div>                                    <div class="col-6">                                        <h6 class="text-warning">{{ tech.avg_completion_time }}</h6>                                        <small class="text-muted">Tempo Medio</small>                                    </div>                                </div>                            </div>                        </div>                    </div>                    {% endfor %}                </div>            </div>        </div>    </div>    <!-- Monthly Trend Chart -->    <div class="report-section">        <div class="card">            <div class="card-header">                <h4><i class="fas fa-chart-area"></i> Trend Ultimi 12 Mesi</h4>            </div>            <div class="card-body">                <canvas id="monthlyTrendChart" height="100"></canvas>            </div>        </div>    </div>    <!-- Report Footer -->    <div class="mt-5 pt-3 border-top">        <div class="row">            <div class="col-md-6">                <p class="text-muted">                    <strong>Report generato il:</strong> {{ "now"|date:"d/m/Y H:i" }}<br>                    <strong>Periodo analizzato:</strong> Ultimi {{ period_days }} giorni<br>                    <strong>Azienda:</strong> {{ company.name }}                </p>            </div>            <div class="col-md-6 text-end">                <p class="text-muted">                    <strong>DispatchLight Analytics</strong><br>                    Sistema di gestione operativa per furgoni<br>                    <em>Report confidenziale</em>                </p>            </div>        </div>    </div></div><script>// Monthly trend chartconst monthlyData = {{ monthly_performance|safe }};const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');new Chart(monthlyTrendCtx, {    type: 'line',    data: {        labels: monthlyData.map(item => item.month_year),        datasets: [{            label: 'Fatturato Mensile (€)',            data: monthlyData.map(item => item.revenue),            borderColor: 'rgb(75, 192, 192)',            backgroundColor: 'rgba(75, 192, 192, 0.1)',            tension: 0.4,            fill: true        }]    },    options: {        responsive: true,        scales: {            y: {                beginAtZero: true,                title: {                    display: true,                    text: 'Fatturato (€)'                }            }        },        plugins: {            legend: {                position: 'top',            },            title: {                display: true,                text: 'Evoluzione Fatturato Mensile'            }        }    }});// Export functionsfunction exportToPDF() {    alert('Funzionalità export PDF in sviluppo!');}function exportToExcel() {    alert('Funzionalità export Excel in sviluppo!');}</script>{% endblock %}