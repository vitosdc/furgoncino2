{% extends 'base.html' %}{% block title %}Dashboard - DispatchLight{% endblock %}{% block content %}<div class="row">    <div class="col-12">        <div class="d-flex justify-content-between align-items-center mb-4">            <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>            {% if company %}                <span class="badge bg-primary fs-6">{{ company.name }}</span>            {% endif %}        </div>    </div></div>{% if company %}<!-- Statistics Cards --><div class="row mb-4">    <div class="col-md-3">        <div class="card card-stats text-white bg-warning">            <div class="card-body">                <div class="d-flex align-items-center">                    <div class="flex-grow-1">                        <h5 class="card-title">Ordini in Attesa</h5>                        <h2 class="mb-0">{{ pending_orders }}</h2>                    </div>                    <div class="flex-shrink-0">                        <i class="fas fa-clock fa-2x"></i>                    </div>                </div>            </div>        </div>    </div>        <div class="col-md-3">        <div class="card card-stats text-white bg-info">            <div class="card-body">                <div class="d-flex align-items-center">                    <div class="flex-grow-1">                        <h5 class="card-title">Ordini Oggi</h5>                        <h2 class="mb-0">{{ today_orders }}</h2>                    </div>                    <div class="flex-shrink-0">                        <i class="fas fa-calendar-day fa-2x"></i>                    </div>                </div>            </div>        </div>    </div>        <div class="col-md-3">        <div class="card card-stats text-white bg-success">            <div class="card-body">                <div class="d-flex align-items-center">                    <div class="flex-grow-1">                        <h5 class="card-title">Tecnici Attivi</h5>                        <h2 class="mb-0">{{ active_technicians }}</h2>                    </div>                    <div class="flex-shrink-0">                        <i class="fas fa-user-cog fa-2x"></i>                    </div>                </div>            </div>        </div>    </div>        <div class="col-md-3">        <div class="card card-stats text-white bg-primary">            <div class="card-body">                <div class="d-flex align-items-center">                    <div class="flex-grow-1">                        <h5 class="card-title">Analytics</h5>                        <p class="mb-0">Visualizza Report</p>                    </div>                    <div class="flex-shrink-0">                        <i class="fas fa-chart-line fa-2x"></i>                    </div>                </div>            </div>        </div>    </div></div><!-- Quick Actions --><div class="row mb-4">    <div class="col-12">        <div class="card">            <div class="card-header">                <h5><i class="fas fa-bolt"></i> Azioni Rapide</h5>            </div>            <div class="card-body">                <div class="row">                    <div class="col-md-6 col-lg-3 mb-2">                        <a href="{% url 'core:order_create' %}" class="btn btn-primary w-100">                            <i class="fas fa-plus"></i> Nuovo Ordine                        </a>                    </div>                    <div class="col-md-6 col-lg-3 mb-2">                        <a href="{% url 'core:live_map' %}" class="btn btn-info w-100">                            <i class="fas fa-map-marked-alt"></i> Mappa Live                        </a>                    </div>                    <div class="col-md-6 col-lg-3 mb-2">                        <a href="{% url 'core:analytics' %}" class="btn btn-warning w-100">                            <i class="fas fa-chart-line"></i> Analytics                        </a>                    </div>                </div>            </div>        </div>    </div></div><!-- Mini Analytics Widget --><div class="row mb-4">    <div class="col-12">        <div class="card">            <div class="card-header d-flex justify-content-between align-items-center">                <h5><i class="fas fa-chart-pie"></i> Panoramica Performance</h5>                <a href="{% url 'core:analytics' %}" class="btn btn-sm btn-outline-primary">                    <i class="fas fa-chart-line"></i> Analytics Completa                </a>            </div>            <div class="card-body">                <div class="row">                    <!-- Mini Chart -->                    <div class="col-md-6">                        <h6 class="text-muted mb-3">Ultimi 7 Giorni</h6>                        <!-- Container con altezza fissa -->                        <div style="position: relative; height: 200px; width: 100%;">                            <canvas id="miniPerformanceChart"></canvas>                        </div>                    </div>                                        <!-- Quick Stats -->                    <div class="col-md-6">                        <h6 class="text-muted mb-3">Metriche Chiave</h6>                        <div class="row g-3">                            <div class="col-6">                                <div class="text-center p-2 bg-light rounded">                                    <h5 class="text-success mb-1">{{ completion_rate|default:0 }}%</h5>                                    <small class="text-muted">Tasso Completamento</small>                                </div>                            </div>                            <div class="col-6">                                <div class="text-center p-2 bg-light rounded">                                    <h5 class="text-primary mb-1">{{ avg_hours|default:0 }}h</h5>                                    <small class="text-muted">Tempo Medio</small>                                </div>                            </div>                            <div class="col-6">                                <div class="text-center p-2 bg-light rounded">                                    <h5 class="text-info mb-1">â‚¬{{ avg_order_value|default:0|floatformat:0 }}</h5>                                    <small class="text-muted">Valore Medio</small>                                </div>                            </div>                            <div class="col-6">                                <div class="text-center p-2 bg-light rounded">                                    <h5 class="text-warning mb-1">{{ total_orders|default:0 }}</h5>                                    <small class="text-muted">Ordini Totali</small>                                </div>                            </div>                        </div>                                                <!-- Trend Indicators -->                        <div class="mt-3">                            <div class="d-flex justify-content-between align-items-center mb-2">                                <span class="small text-muted">Performance:</span>                                {% if completion_rate >= 80 %}                                    <span class="badge bg-success">                                        <i class="fas fa-arrow-up"></i> Eccellente                                    </span>                                {% elif completion_rate >= 60 %}                                    <span class="badge bg-warning">                                        <i class="fas fa-arrow-right"></i> Buona                                    </span>                                {% else %}                                    <span class="badge bg-info">                                        <i class="fas fa-arrow-up"></i> In crescita                                    </span>                                {% endif %}                            </div>                            <div class="progress" style="height: 8px;">                                <div class="progress-bar bg-gradient" style="width: {{ completion_rate|default:10 }}%"></div>                            </div>                        </div>                    </div>                </div>            </div>        </div>    </div></div><!-- Recent Orders --><div class="row">    <div class="col-12">        <div class="card">            <div class="card-header d-flex justify-content-between align-items-center">                <h5><i class="fas fa-clipboard-list"></i> Ordini Recenti</h5>                <a href="{% url 'core:order_list' %}" class="btn btn-sm btn-outline-primary">                    Vedi Tutti                </a>            </div>            <div class="card-body">                {% if recent_orders %}                <div class="table-responsive">                    <table class="table table-hover">                        <thead>                            <tr>                                <th>Numero</th>                                <th>Cliente</th>                                <th>Titolo</th>                                <th>Stato</th>                                <th>Tecnico</th>                                <th>Data</th>                                <th>Azioni</th>                            </tr>                        </thead>                        <tbody>                            {% for order in recent_orders %}                            <tr>                                <td><strong>{{ order.order_number }}</strong></td>                                <td>{{ order.customer.name }}</td>                                <td>{{ order.title|truncatechars:30 }}</td>                                <td>                                    {% if order.status == 'PENDING' %}                                        <span class="badge bg-warning">Da Assegnare</span>                                    {% elif order.status == 'ASSIGNED' %}                                        <span class="badge bg-info">Assegnato</span>                                    {% elif order.status == 'EN_ROUTE' %}                                        <span class="badge bg-primary">In Viaggio</span>                                    {% elif order.status == 'ON_SITE' %}                                        <span class="badge bg-secondary">Sul Posto</span>                                    {% elif order.status == 'COMPLETED' %}                                        <span class="badge bg-success">Completato</span>                                    {% elif order.status == 'CANCELLED' %}                                        <span class="badge bg-danger">Annullato</span>                                    {% endif %}                                </td>                                <td>                                    {% if order.technician %}                                        {{ order.technician.user.get_full_name }}                                    {% else %}                                        <span class="text-muted">Non assegnato</span>                                    {% endif %}                                </td>                                <td>{{ order.created_at|date:"d/m/Y H:i" }}</td>                                <td>                                    <a href="{% url 'core:order_detail' order.pk %}" class="btn btn-sm btn-outline-primary">                                        <i class="fas fa-eye"></i>                                    </a>                                </td>                            </tr>                            {% endfor %}                        </tbody>                    </table>                </div>                {% else %}                <div class="text-center py-4">                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>                    <h5 class="text-muted">Nessun ordine presente</h5>                    <p class="text-muted">Inizia creando il tuo primo ordine di lavoro!</p>                    <a href="{% url 'core:order_create' %}" class="btn btn-primary">                        <i class="fas fa-plus"></i> Crea Primo Ordine                    </a>                </div>                {% endif %}            </div>        </div>    </div></div>{% else %}<!-- Setup aziendale necessario --><div class="row justify-content-center">    <div class="col-md-8">        <div class="card">            <div class="card-body text-center">                <i class="fas fa-building fa-3x text-primary mb-3"></i>                <h3>Benvenuto in DispatchLight!</h3>                <p class="lead">Prima di iniziare, Ã¨ necessario configurare la tua azienda.</p>                <p>Vai nell'area amministrativa per creare la tua azienda e iniziare a gestire i tuoi ordini di lavoro.</p>                <a href="/admin/" class="btn btn-primary btn-lg">                    <i class="fas fa-cogs"></i> Configura Azienda                </a>            </div>        </div>    </div></div>{% endif %}<!-- Script per Mini Chart CON DATI REALI --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script>// Aspetta che il DOM sia caricatodocument.addEventListener('DOMContentLoaded', function() {    // Mini Performance Chart con DATI REALI    const miniCanvas = document.getElementById('miniPerformanceChart');    if (miniCanvas) {        const miniCtx = miniCanvas.getContext('2d');                // Distruggi chart esistente se presente        if (window.miniChart) {            window.miniChart.destroy();        }                // DATI REALI dal database        const realData = [{{ last_7_days_data|join:"," }}];                window.miniChart = new Chart(miniCtx, {            type: 'line',            data: {                labels: ['6gg fa', '5gg fa', '4gg fa', '3gg fa', '2gg fa', 'Ieri', 'Oggi'],                datasets: [{                    label: 'Ordini Reali',                    data: realData,  // USANO I DATI VERI                    borderColor: 'rgb(75, 192, 192)',                    backgroundColor: 'rgba(75, 192, 192, 0.1)',                    tension: 0.4,                    fill: true,                    pointRadius: 4,                    pointHoverRadius: 6,                    pointBackgroundColor: 'rgb(75, 192, 192)',                    pointBorderColor: '#fff',                    pointBorderWidth: 2                }]            },            options: {                responsive: true,                maintainAspectRatio: false,                scales: {                    x: {                        display: true,                        grid: {                            display: false                        },                        ticks: {                            font: {                                size: 11                            }                        }                    },                    y: {                        display: true,                        beginAtZero: true,                        grid: {                            color: 'rgba(0,0,0,0.1)'                        },                        ticks: {                            stepSize: 1,                            font: {                                size: 11                            }                        }                    }                },                plugins: {                    legend: {                        display: false                    },                    tooltip: {                        mode: 'index',                        intersect: false,                        backgroundColor: 'rgba(0,0,0,0.8)',                        titleColor: '#fff',                        bodyColor: '#fff',                        borderColor: 'rgb(75, 192, 192)',                        borderWidth: 1,                        callbacks: {                            title: function(context) {                                return context[0].label;                            },                            label: function(context) {                                const value = context.parsed.y;                                return value === 1 ? '1 ordine' : value + ' ordini';                            }                        }                    }                },                elements: {                    point: {                        hoverBackgroundColor: '#fff',                        hoverBorderColor: 'rgb(75, 192, 192)',                        hoverBorderWidth: 3                    }                }            }        });    }});// Distruggi chart quando si cambia paginawindow.addEventListener('beforeunload', function() {    if (window.miniChart) {        window.miniChart.destroy();    }});</script>{% endblock %}