<!-- templates/core/technician_edit.html - TEMPLATE COMPLETO CORRETTO -->{% extends 'base.html' %}{% block title %}Modifica {{ technician.user.get_full_name }} - DispatchLight{% endblock %}{% block extra_css %}<style>    .form-section {        background: #f8f9fa;        border-left: 4px solid #007bff;        padding: 20px;        margin-bottom: 20px;        border-radius: 5px;    }        .gps-coordinates {        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);        border: 1px solid #2196f3;        border-radius: 8px;        padding: 15px;    }        .password-section {        background: linear-gradient(135deg, #fff3e0, #fce4ec);        border: 1px solid #ff9800;        border-radius: 8px;        padding: 15px;    }        .info-card {        background: #e8f5e8;        border: 1px solid #4caf50;        border-radius: 8px;        padding: 15px;        margin-bottom: 20px;    }        .warning-card {        background: #fff3cd;        border: 1px solid #ffc107;        border-radius: 8px;        padding: 15px;        margin-bottom: 20px;    }        .coordinates-helper {        font-size: 0.85em;        color: #6c757d;        margin-top: 5px;    }        .form-control:focus {        border-color: #007bff;        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);    }        .form-check-input:checked {        background-color: #28a745;        border-color: #28a745;    }        .btn-group-custom {        gap: 10px;    }        .coordinate-display {        background: #f1f3f4;        padding: 8px 12px;        border-radius: 5px;        font-family: monospace;        font-size: 0.9em;    }</style>{% endblock %}{% block content %}<div class="container my-4">    <div class="row">        <div class="col-12">            <div class="d-flex justify-content-between align-items-center mb-4">                <h1><i class="fas fa-user-edit"></i> Modifica Tecnico Completo</h1>                <div class="btn-group-custom d-flex">                    <a href="{% url 'core:technician_detail' technician.pk %}" class="btn btn-outline-secondary">                        <i class="fas fa-arrow-left"></i> Torna ai Dettagli                    </a>                    <a href="{% url 'core:technician_list' %}" class="btn btn-outline-info">                        <i class="fas fa-list"></i> Lista Tecnici                    </a>                </div>            </div>        </div>    </div>    <div class="row">        <div class="col-lg-8">            <!-- Avviso Permessi -->            <div class="info-card">                <h6><i class="fas fa-crown text-warning"></i> Modalità Proprietario Attiva</h6>                <p class="mb-0">                    <strong>Hai accesso completo a tutti i dati del tecnico.</strong><br>                    Puoi modificare nome, cognome, email, username, posizione GPS e reimpostare la password.                    <small class="text-muted d-block mt-1">                        <i class="fas fa-shield-alt"></i> Solo il proprietario dell'azienda può accedere a questa funzione.                    </small>                </p>            </div>            <div class="card">                <div class="card-header bg-primary text-white">                    <h5><i class="fas fa-user-cog"></i> Modifica Completa - {{ technician.user.get_full_name }}</h5>                </div>                <div class="card-body">                    <form method="post" id="technicianEditForm">                        {% csrf_token %}                        <!-- SEZIONE DATI PERSONALI -->                        <div class="form-section">                            <h6 class="border-bottom pb-2 mb-3">                                <i class="fas fa-user"></i> Dati Personali                            </h6>                            <div class="row">                                <div class="col-md-6 mb-3">                                    <label for="{{ form.first_name.id_for_label }}" class="form-label">                                        <i class="fas fa-signature"></i> {{ form.first_name.label }}                                    </label>                                    {{ form.first_name }}                                    {% if form.first_name.errors %}                                        <div class="text-danger small mt-1">{{ form.first_name.errors }}</div>                                    {% endif %}                                    <div class="form-text">Nome utilizzato per identificare il tecnico</div>                                </div>                                                                <div class="col-md-6 mb-3">                                    <label for="{{ form.last_name.id_for_label }}" class="form-label">                                        <i class="fas fa-signature"></i> {{ form.last_name.label }}                                    </label>                                    {{ form.last_name }}                                    {% if form.last_name.errors %}                                        <div class="text-danger small mt-1">{{ form.last_name.errors }}</div>                                    {% endif %}                                    <div class="form-text">Cognome per documenti e comunicazioni ufficiali</div>                                </div>                            </div>                            <div class="row">                                <div class="col-md-6 mb-3">                                    <label for="{{ form.username.id_for_label }}" class="form-label">                                        <i class="fas fa-at"></i> {{ form.username.label }}                                    </label>                                    {{ form.username }}                                    {% if form.username.help_text %}                                        <div class="form-text">{{ form.username.help_text }}</div>                                    {% endif %}                                    {% if form.username.errors %}                                        <div class="text-danger small mt-1">{{ form.username.errors }}</div>                                    {% endif %}                                </div>                                                                <div class="col-md-6 mb-3">                                    <label for="{{ form.email.id_for_label }}" class="form-label">                                        <i class="fas fa-envelope"></i> {{ form.email.label }}                                    </label>                                    {{ form.email }}                                    {% if form.email.help_text %}                                        <div class="form-text">{{ form.email.help_text }}</div>                                    {% endif %}                                    {% if form.email.errors %}                                        <div class="text-danger small mt-1">{{ form.email.errors }}</div>                                    {% endif %}                                </div>                            </div>                        </div>                        <!-- SEZIONE DATI TECNICO -->                        <div class="form-section">                            <h6 class="border-bottom pb-2 mb-3">                                <i class="fas fa-tools"></i> Dati Operativi                            </h6>                            <div class="row">                                <div class="col-md-6 mb-3">                                    <label for="{{ form.phone.id_for_label }}" class="form-label">                                        <i class="fas fa-phone"></i> {{ form.phone.label }}                                    </label>                                    {{ form.phone }}                                    {% if form.phone.help_text %}                                        <div class="form-text">{{ form.phone.help_text }}</div>                                    {% endif %}                                    {% if form.phone.errors %}                                        <div class="text-danger small mt-1">{{ form.phone.errors }}</div>                                    {% endif %}                                </div>                                                                <div class="col-md-6 mb-3">                                    <label for="{{ form.vehicle_plate.id_for_label }}" class="form-label">                                        <i class="fas fa-car"></i> {{ form.vehicle_plate.label }}                                    </label>                                    {{ form.vehicle_plate }}                                    {% if form.vehicle_plate.help_text %}                                        <div class="form-text">{{ form.vehicle_plate.help_text }}</div>                                    {% endif %}                                    {% if form.vehicle_plate.errors %}                                        <div class="text-danger small mt-1">{{ form.vehicle_plate.errors }}</div>                                    {% endif %}                                </div>                            </div>                            <div class="mb-3">                                <div class="form-check form-switch">                                    {{ form.is_active }}                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">                                        <i class="fas fa-toggle-on"></i> <strong>{{ form.is_active.label }}</strong>                                    </label>                                    {% if form.is_active.errors %}                                        <div class="text-danger small mt-1">{{ form.is_active.errors }}</div>                                    {% endif %}                                </div>                                {% if form.is_active.help_text %}                                    <small class="form-text text-muted ms-4">{{ form.is_active.help_text }}</small>                                {% endif %}                            </div>                        </div>                        <!-- SEZIONE POSIZIONE GPS -->                        <div class="gps-coordinates">                            <h6 class="border-bottom pb-2 mb-3">                                <i class="fas fa-map-marker-alt text-success"></i> Gestione Posizione GPS                            </h6>                                                        <!-- Posizione Attuale -->                            {% if technician.current_latitude and technician.current_longitude %}                            <div class="alert alert-success mb-3">                                <h6><i class="fas fa-check-circle"></i> Posizione GPS Attuale</h6>                                <div class="row">                                    <div class="col-md-6">                                        <strong>Latitudine:</strong>                                        <div class="coordinate-display">{{ technician.current_latitude|floatformat:8 }}</div>                                    </div>                                    <div class="col-md-6">                                        <strong>Longitudine:</strong>                                        <div class="coordinate-display">{{ technician.current_longitude|floatformat:8 }}</div>                                    </div>                                </div>                                {% if technician.last_location_update %}                                    <small class="text-muted">                                        <i class="fas fa-clock"></i>                                         Ultimo aggiornamento: {{ technician.last_location_update|date:"d/m/Y H:i:s" }}                                    </small>                                {% endif %}                            </div>                            {% else %}                            <div class="alert alert-warning mb-3">                                <i class="fas fa-exclamation-triangle"></i>                                <strong>Nessuna posizione GPS registrata</strong><br>                                <small>Il tecnico non ha ancora condiviso la sua posizione o non è mai stato localizzato.</small>                            </div>                            {% endif %}                            <!-- Campi per Impostare Nuova Posizione -->                            <div class="row">                                <div class="col-md-6 mb-3">                                    <label for="{{ form.current_latitude.id_for_label }}" class="form-label">                                        <i class="fas fa-globe-americas"></i> {{ form.current_latitude.label }}                                    </label>                                    {{ form.current_latitude }}                                    {% if form.current_latitude.help_text %}                                        <div class="coordinates-helper">{{ form.current_latitude.help_text }}</div>                                    {% endif %}                                    {% if form.current_latitude.errors %}                                        <div class="text-danger small mt-1">{{ form.current_latitude.errors }}</div>                                    {% endif %}                                </div>                                                                <div class="col-md-6 mb-3">                                    <label for="{{ form.current_longitude.id_for_label }}" class="form-label">                                        <i class="fas fa-globe-americas"></i> {{ form.current_longitude.label }}                                    </label>                                    {{ form.current_longitude }}                                    {% if form.current_longitude.help_text %}                                        <div class="coordinates-helper">{{ form.current_longitude.help_text }}</div>                                    {% endif %}                                    {% if form.current_longitude.errors %}                                        <div class="text-danger small mt-1">{{ form.current_longitude.errors }}</div>                                    {% endif %}                                </div>                            </div>                            <div class="alert alert-info mt-3">                                <h6><i class="fas fa-info-circle"></i> Come trovare le coordinate GPS:</h6>                                <ul class="mb-0 small">                                    <li><strong>Google Maps:</strong> Fai clic destro su una posizione → "Cosa c'è qui?" → Copia le coordinate</li>                                    <li><strong>Smartphone:</strong> App GPS o Mappe → Condividi posizione → Copia coordinate</li>                                    <li><strong>Roma Centro:</strong> 41.9028, 12.4964 (esempio di riferimento)</li>                                    <li><strong>Lascia vuoto:</strong> Per mantenere la posizione attuale del tecnico</li>                                </ul>                            </div>                        </div>                        <!-- SEZIONE GESTIONE PASSWORD -->                        <div class="password-section">                            <h6 class="border-bottom pb-2 mb-3">                                <i class="fas fa-key text-warning"></i> Gestione Password                            </h6>                                                        <div class="mb-3">                                <div class="form-check">                                    {{ form.change_password }}                                    <label class="form-check-label" for="{{ form.change_password.id_for_label }}">                                        <strong>{{ form.change_password.label }}</strong>                                    </label>                                    {% if form.change_password.help_text %}                                        <div class="form-text">{{ form.change_password.help_text }}</div>                                    {% endif %}                                    {% if form.change_password.errors %}                                        <div class="text-danger small mt-1">{{ form.change_password.errors }}</div>                                    {% endif %}                                </div>                            </div>                            <div id="passwordFields" style="display: none;">                                <div class="row">                                    <div class="col-md-6 mb-3">                                        <label for="{{ form.new_password.id_for_label }}" class="form-label">                                            <i class="fas fa-lock"></i> {{ form.new_password.label }}                                        </label>                                        {{ form.new_password }}                                        {% if form.new_password.help_text %}                                            <div class="form-text">{{ form.new_password.help_text }}</div>                                        {% endif %}                                        {% if form.new_password.errors %}                                            <div class="text-danger small mt-1">{{ form.new_password.errors }}</div>                                        {% endif %}                                    </div>                                                                        <div class="col-md-6 mb-3">                                        <label for="{{ form.confirm_password.id_for_label }}" class="form-label">                                            <i class="fas fa-lock"></i> {{ form.confirm_password.label }}                                        </label>                                        {{ form.confirm_password }}                                        {% if form.confirm_password.errors %}                                            <div class="text-danger small mt-1">{{ form.confirm_password.errors }}</div>                                        {% endif %}                                    </div>                                </div>                                                                <div class="alert alert-warning">                                    <i class="fas fa-exclamation-triangle"></i>                                    <strong>Attenzione:</strong> Il tecnico dovrà utilizzare la nuova password al prossimo accesso.                                    Assicurati di comunicargliela in modo sicuro.                                </div>                            </div>                        </div>                        <!-- Errori generali del form -->                        {% if form.non_field_errors %}                            <div class="alert alert-danger">                                <h6><i class="fas fa-exclamation-circle"></i> Errori di Validazione:</h6>                                {{ form.non_field_errors }}                            </div>                        {% endif %}                        <!-- Pulsanti di azione -->                        <div class="d-flex justify-content-end gap-3 mt-4">                            <a href="{% url 'core:technician_detail' technician.pk %}" class="btn btn-secondary">                                <i class="fas fa-times"></i> Annulla Modifiche                            </a>                            <button type="button" class="btn btn-warning" onclick="resetForm()">                                <i class="fas fa-undo"></i> Ripristina                            </button>                            <button type="submit" class="btn btn-primary btn-lg">                                <i class="fas fa-save"></i> Salva Tutte le Modifiche                            </button>                        </div>                    </form>                </div>            </div>        </div>        <!-- PANNELLO LATERALE CON INFO E AZIONI AVANZATE -->        <div class="col-lg-4">            <!-- Informazioni Attuali -->            <div class="card mb-4">                <div class="card-header bg-info text-white">                    <h6><i class="fas fa-info-circle"></i> Informazioni Attuali</h6>                </div>                <div class="card-body">                    <dl class="row mb-0">                        <dt class="col-5">Nome Completo:</dt>                        <dd class="col-7">{{ technician.user.get_full_name }}</dd>                                                <dt class="col-5">Username:</dt>                        <dd class="col-7"><code>{{ technician.user.username }}</code></dd>                                                <dt class="col-5">Email:</dt>                        <dd class="col-7">{{ technician.user.email }}</dd>                                                <dt class="col-5">Telefono:</dt>                        <dd class="col-7">{{ technician.phone }}</dd>                                                <dt class="col-5">Stato:</dt>                        <dd class="col-7">                            {% if technician.is_active %}                                <span class="badge bg-success">Attivo</span>                            {% else %}                                <span class="badge bg-secondary">Inattivo</span>                            {% endif %}                        </dd>                                                <dt class="col-5">Creato il:</dt>                        <dd class="col-7">{{ technician.user.date_joined|date:"d/m/Y" }}</dd>                    </dl>                </div>            </div>            <!-- Statistiche Veloci -->            <div class="card mb-4">                <div class="card-header bg-success text-white">                    <h6><i class="fas fa-chart-bar"></i> Statistiche Rapide</h6>                </div>                <div class="card-body">                    <div class="row text-center">                        <div class="col-6">                            <h4 class="text-primary">                                {{ technician.work_orders.count }}                            </h4>                            <small class="text-muted">Ordini Totali</small>                        </div>                        <div class="col-6">                            <h4 class="text-success">                                -                            </h4>                            <small class="text-muted">Completati</small>                        </div>                    </div>                    <hr>                    <div class="text-center">                        <h5 class="text-warning">                            -                        </h5>                        <small class="text-muted">Ordini Attivi</small>                    </div>                </div>            </div>            <!-- Azioni Avanzate -->            <div class="card mb-4">                <div class="card-header bg-warning text-dark">                    <h6><i class="fas fa-tools"></i> Azioni Avanzate</h6>                </div>                <div class="card-body">                    <div class="d-grid gap-2">                        <button class="btn btn-outline-primary btn-sm" onclick="getLocationFromBrowser()">                            <i class="fas fa-crosshairs"></i> Usa La Mia Posizione                        </button>                                                <button class="btn btn-outline-info btn-sm" onclick="showMapModal()">                            <i class="fas fa-map"></i> Seleziona su Mappa                        </button>                                                <button class="btn btn-outline-warning btn-sm" onclick="clearGPSData()">                            <i class="fas fa-map-marker-slash"></i> Cancella GPS                        </button>                                                <hr>                                                <button class="btn btn-outline-danger btn-sm" onclick="generateRandomPassword()">                            <i class="fas fa-dice"></i> Password Casuale                        </button>                    </div>                </div>            </div>            <!-- Aiuto e Informazioni -->            <div class="card">                <div class="card-header bg-secondary text-white">                    <h6><i class="fas fa-question-circle"></i> Aiuto</h6>                </div>                <div class="card-body">                    <h6>Cosa puoi modificare:</h6>                    <ul class="small">                        <li><strong>Dati Personali:</strong> Nome, cognome, email, username</li>                        <li><strong>Dati Operativi:</strong> Telefono, veicolo, stato attivo</li>                        <li><strong>Posizione GPS:</strong> Coordinate manuali precise</li>                        <li><strong>Sicurezza:</strong> Reset password completo</li>                    </ul>                                        <h6 class="mt-3">Note Importanti:</h6>                    <ul class="small mb-0">                        <li>Le modifiche sono <strong>immediate</strong></li>                        <li>Il tecnico vedrà i cambiamenti al prossimo accesso</li>                        <li>La posizione GPS sovrascrive quella automatica</li>                        <li>Tutte le modifiche sono registrate nel log</li>                    </ul>                </div>            </div>        </div>    </div></div><!-- Modal per Selezione Mappa (stub) --><div class="modal fade" id="mapModal" tabindex="-1">    <div class="modal-dialog modal-lg">        <div class="modal-content">            <div class="modal-header">                <h5 class="modal-title">                    <i class="fas fa-map-marked-alt"></i> Seleziona Posizione sulla Mappa                </h5>                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>            </div>            <div class="modal-body">                <div class="alert alert-info">                    <i class="fas fa-info-circle"></i>                    <strong>Funzionalità in arrivo!</strong><br>                    Sarà possibile selezionare la posizione direttamente dalla mappa interattiva.                    Per ora, usa le coordinate manuali o la geolocalizzazione del browser.                </div>                <div id="modalMap" style="height: 400px; background: #f8f9fa; display: flex; align-items: center; justify-content: center;">                    <span class="text-muted">                        <i class="fas fa-map fa-3x"></i><br>                        Mappa Interattiva                    </span>                </div>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>                <button type="button" class="btn btn-primary" onclick="selectMapLocation()">                    <i class="fas fa-check"></i> Conferma Posizione                </button>            </div>        </div>    </div></div>{% endblock %}{% block extra_js %}<script>// Gestione visibilità campi passworddocument.addEventListener('DOMContentLoaded', function() {    const changePasswordCheckbox = document.getElementById('{{ form.change_password.id_for_label }}');    const passwordFields = document.getElementById('passwordFields');    const newPasswordField = document.getElementById('{{ form.new_password.id_for_label }}');    const confirmPasswordField = document.getElementById('{{ form.confirm_password.id_for_label }}');    function togglePasswordFields() {        if (changePasswordCheckbox.checked) {            passwordFields.style.display = 'block';            newPasswordField.required = true;            confirmPasswordField.required = true;        } else {            passwordFields.style.display = 'none';            newPasswordField.required = false;            confirmPasswordField.required = false;            newPasswordField.value = '';            confirmPasswordField.value = '';        }    }    changePasswordCheckbox.addEventListener('change', togglePasswordFields);    togglePasswordFields(); // Inizializza stato});// Funzione per ottenere posizione dal browserfunction getLocationFromBrowser() {    if (!navigator.geolocation) {        alert('La geolocalizzazione non è supportata da questo browser.');        return;    }    const btn = event.target;    const originalText = btn.innerHTML;    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rilevamento...';    btn.disabled = true;    navigator.geolocation.getCurrentPosition(        function(position) {            const lat = position.coords.latitude.toFixed(8);            const lng = position.coords.longitude.toFixed(8);                        document.getElementById('{{ form.current_latitude.id_for_label }}').value = lat;            document.getElementById('{{ form.current_longitude.id_for_label }}').value = lng;                        showNotification(`Posizione rilevata: ${lat}, ${lng}`, 'success');            btn.innerHTML = originalText;            btn.disabled = false;        },        function(error) {            let errorMsg = 'Impossibile rilevare la posizione. ';            switch(error.code) {                case error.PERMISSION_DENIED:                    errorMsg += 'Autorizzazione negata.';                    break;                case error.POSITION_UNAVAILABLE:                    errorMsg += 'Posizione non disponibile.';                    break;                case error.TIMEOUT:                    errorMsg += 'Timeout richiesta.';                    break;                default:                    errorMsg += 'Errore sconosciuto.';            }            alert(errorMsg);            btn.innerHTML = originalText;            btn.disabled = false;        },        {            enableHighAccuracy: true,            timeout: 10000,            maximumAge: 0        }    );}// Funzione per mostrare modal mappafunction showMapModal() {    const mapModal = new bootstrap.Modal(document.getElementById('mapModal'));    mapModal.show();}// Funzione per selezionare posizione dalla mappa (stub)function selectMapLocation() {    // TODO: Implementare selezione dalla mappa    alert('Funzionalità di selezione mappa in arrivo nella prossima versione!');}// Funzione per cancellare dati GPSfunction clearGPSData() {    if (confirm('Vuoi davvero cancellare i dati GPS del tecnico?')) {        document.getElementById('{{ form.current_latitude.id_for_label }}').value = '';        document.getElementById('{{ form.current_longitude.id_for_label }}').value = '';        showNotification('Dati GPS cancellati. Ricorda di salvare per applicare le modifiche.', 'warning');    }}// Funzione per generare password casualefunction generateRandomPassword() {    const length = 12;    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*";    let password = "";        for (let i = 0; i < length; i++) {        password += charset.charAt(Math.floor(Math.random() * charset.length));    }    // Funzione per generare password casualefunction generateRandomPassword() {    const length = 12;    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*";    let password = "";        for (let i = 0; i < length; i++) {        password += charset.charAt(Math.floor(Math.random() * charset.length));    }        document.getElementById('{{ form.change_password.id_for_label }}').checked = true;    document.getElementById('{{ form.new_password.id_for_label }}').value = password;    document.getElementById('{{ form.confirm_password.id_for_label }}').value = password;        // Mostra i campi password    document.getElementById('passwordFields').style.display = 'block';    document.getElementById('{{ form.new_password.id_for_label }}').required = true;    document.getElementById('{{ form.confirm_password.id_for_label }}').required = true;        showNotification(`Password generata: ${password}`, 'info');}// Funzione per ripristinare il formfunction resetForm() {    if (confirm('Vuoi davvero ripristinare tutte le modifiche ai valori originali?')) {        document.getElementById('technicianEditForm').reset();        document.getElementById('passwordFields').style.display = 'none';        showNotification('Form ripristinato ai valori originali.', 'info');    }}// Utility per mostrare notifichefunction showNotification(message, type = 'info') {    const alertClass = type === 'success' ? 'alert-success' :                       type === 'warning' ? 'alert-warning' :                      type === 'error' ? 'alert-danger' : 'alert-info';        const notification = document.createElement('div');    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;    notification.style.cssText = `        top: 20px;        right: 20px;        z-index: 9999;        min-width: 300px;        max-width: 500px;        box-shadow: 0 4px 12px rgba(0,0,0,0.15);    `;    notification.innerHTML = `        <i class="fas fa-${type === 'success' ? 'check-circle' :                            type === 'warning' ? 'exclamation-triangle' :                           type === 'error' ? 'times-circle' : 'info-circle'}"></i>        ${message}        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>    `;        document.body.appendChild(notification);        // Auto-remove dopo 5 secondi    setTimeout(() => {        if (notification.parentNode) {            notification.remove();        }    }, 5000);}// Validazione form miglioratadocument.getElementById('technicianEditForm').addEventListener('submit', function(e) {    const lat = document.getElementById('{{ form.current_latitude.id_for_label }}').value;    const lng = document.getElementById('{{ form.current_longitude.id_for_label }}').value;        // Validazione coordinate    if (lat && !lng) {        e.preventDefault();        alert('Se inserisci la latitudine, devi inserire anche la longitudine.');        return false;    }        if (lng && !lat) {        e.preventDefault();        alert('Se inserisci la longitudine, devi inserire anche la latitudine.');        return false;    }        // Validazione range coordinate    if (lat && (parseFloat(lat) < -90 || parseFloat(lat) > 90)) {        e.preventDefault();        alert('La latitudine deve essere compresa tra -90 e +90.');        return false;    }        if (lng && (parseFloat(lng) < -180 || parseFloat(lng) > 180)) {        e.preventDefault();        alert('La longitudine deve essere compresa tra -180 e +180.');        return false;    }        // Validazione password    const changePassword = document.getElementById('{{ form.change_password.id_for_label }}').checked;    if (changePassword) {        const newPassword = document.getElementById('{{ form.new_password.id_for_label }}').value;        const confirmPassword = document.getElementById('{{ form.confirm_password.id_for_label }}').value;                if (!newPassword) {            e.preventDefault();            alert('Inserisci la nuova password.');            return false;        }                if (newPassword.length < 8) {            e.preventDefault();            alert('La password deve essere di almeno 8 caratteri.');            return false;        }                if (newPassword !== confirmPassword) {            e.preventDefault();            alert('Le password non corrispondono.');            return false;        }    }        // Conferma finale    const hasChanges = Array.from(new FormData(this)).length > 1; // Escludi solo CSRF token    if (hasChanges) {        if (!confirm('Sei sicuro di voler salvare tutte le modifiche al tecnico?')) {            e.preventDefault();            return false;        }    }});// Controlli di validazione in tempo realedocument.getElementById('{{ form.current_latitude.id_for_label }}').addEventListener('blur', function() {    const value = parseFloat(this.value);    if (this.value && (isNaN(value) || value < -90 || value > 90)) {        this.classList.add('is-invalid');        showNotification('Latitudine non valida. Deve essere tra -90 e +90.', 'error');    } else {        this.classList.remove('is-invalid');    }});document.getElementById('{{ form.current_longitude.id_for_label }}').addEventListener('blur', function() {    const value = parseFloat(this.value);    if (this.value && (isNaN(value) || value < -180 || value > 180)) {        this.classList.add('is-invalid');        showNotification('Longitudine non valida. Deve essere tra -180 e +180.', 'error');    } else {        this.classList.remove('is-invalid');    }});</script>{% endblock %}