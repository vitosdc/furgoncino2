{% extends 'base.html' %}{% block title %}Mappa Live - DispatchLight{% endblock %}{% block extra_css %}<!-- Leaflet CSS --><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /><!-- Sortable.js per drag & drop --><script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>{% endblock %}{% block content %}<div class="container-fluid">    <!-- Pannello Controlli Scorrevole -->    <div class="map-panel-overlay" id="panel-overlay" onclick="closeMapPanel()"></div>    <div class="map-control-panel" id="control-panel">        <div class="panel-header">            <h5><i class="fas fa-map-marked-alt"></i> Controlli Mappa Live</h5>            <button class="panel-close-btn" onclick="closeMapPanel()">                <i class="fas fa-times"></i>            </button>        </div>        <div class="panel-content">                        <!-- Sezione Layer Mappa -->            <div class="panel-section">                <h6><i class="fas fa-layers"></i> Tipo di Mappa</h6>                <div class="layer-option" onclick="switchLayerFromPanel('osm')">                    <input type="radio" id="layer-osm-panel" name="mapLayerPanel" value="osm" checked>                    <label for="layer-osm-panel">Stradale Standard</label>                </div>                <div class="layer-option" onclick="switchLayerFromPanel('satellite')">                    <input type="radio" id="layer-satellite-panel" name="mapLayerPanel" value="satellite">                    <label for="layer-satellite-panel">Satellite</label>                </div>                <div class="layer-option" onclick="switchLayerFromPanel('terrain')">                    <input type="radio" id="layer-terrain-panel" name="mapLayerPanel" value="terrain">                    <label for="layer-terrain-panel">Terreno</label>                </div>                <div class="layer-option" onclick="switchLayerFromPanel('dark')">                    <input type="radio" id="layer-dark-panel" name="mapLayerPanel" value="dark">                    <label for="layer-dark-panel">Modalità Scura</label>                </div>            </div>            <!-- Sezione Controlli Vista -->            <div class="panel-section">                <h6><i class="fas fa-eye"></i> Controlli Vista</h6>                <div class="action-controls">                    <button class="control-btn" onclick="showOnlyTechnicians()">                        <i class="fas fa-user-cog"></i>                        Mostra Solo Tecnici                    </button>                    <button class="control-btn" onclick="showOnlyOrders()">                        <i class="fas fa-clipboard-list"></i>                        Mostra Solo Ordini                    </button>                    <button class="control-btn" onclick="showAll()">                        <i class="fas fa-eye"></i>                        Mostra Tutto                    </button>                    <button class="control-btn" id="drag-mode-panel-btn" onclick="toggleDragMode()">                        <i class="fas fa-hand-rock"></i>                        Modalità Trascinamento                    </button>                    <button class="control-btn" onclick="centerAllMarkers()">                        <i class="fas fa-expand-arrows-alt"></i>                        Centra Mappa                    </button>                </div>            </div>            <!-- Sezione Legenda -->            <div class="panel-section">                <h6><i class="fas fa-info-circle"></i> Legenda Simboli</h6>                <div class="panel-legend">                    <div class="legend-item">                        <div class="legend-icon bg-success"></div>                        <span class="legend-text">Tecnico Libero</span>                    </div>                    <div class="legend-item">                        <div class="legend-icon bg-warning"></div>                        <span class="legend-text">Tecnico Occupato</span>                    </div>                    <div class="legend-item">                        <div class="legend-icon bg-primary"></div>                        <span class="legend-text">In Viaggio</span>                    </div>                    <div class="legend-item">                        <div class="legend-icon bg-secondary"></div>                        <span class="legend-text">Offline</span>                    </div>                    <div class="legend-item">                        <div class="legend-icon bg-danger"></div>                        <span class="legend-text">Ordini Urgenti</span>                    </div>                </div>            </div>            <!-- Statistiche Live -->            <div class="panel-section">                <h6><i class="fas fa-chart-bar"></i> Statistiche Live</h6>                <div class="panel-stats">                    <div class="stat-item">                        <div class="stat-number" id="panel-online-count">0</div>                        <div class="stat-label">Online</div>                    </div>                    <div class="stat-item">                        <div class="stat-number" id="panel-working-count">0</div>                        <div class="stat-label">Al Lavoro</div>                    </div>                    <div class="stat-item">                        <div class="stat-number" id="panel-urgent-count">0</div>                        <div class="stat-label">Urgenti</div>                    </div>                    <div class="stat-item">                        <div class="stat-number" id="panel-pending-count">0</div>                        <div class="stat-label">Da Assegnare</div>                    </div>                </div>            </div>            <!-- Sezione Azioni -->            <div class="panel-section">                <h6><i class="fas fa-bolt"></i> Azioni Rapide</h6>                <div class="action-controls">                    <button class="control-btn" onclick="refreshMapData()">                        <i class="fas fa-sync-alt"></i>                        Aggiorna Dati                    </button>                    <button class="control-btn" onclick="toggleAutoRefresh()" id="auto-refresh-panel-btn">                        <i class="fas fa-play"></i>                        Auto Refresh                    </button>                    <button class="control-btn" onclick="optimizeRoutes()">                        <i class="fas fa-route"></i>                        Ottimizza Percorsi                    </button>                    <button class="control-btn" onclick="exportMapData()">                        <i class="fas fa-download"></i>                        Esporta Dati                    </button>                </div>            </div>        </div>    </div>    <div class="row">        <div class="col-12">            <div class="d-flex justify-content-between align-items-center mb-3">                <h1><i class="fas fa-map-marked-alt"></i> Mappa Live</h1>                <div class="btn-group">                    <button class="btn btn-outline-primary" onclick="centerAllMarkers()">                        <i class="fas fa-expand-arrows-alt"></i> Centra Tutto                    </button>                    <button class="btn btn-outline-success" onclick="refreshMapData()">                        <i class="fas fa-sync-alt" id="refresh-icon"></i> Aggiorna                    </button>                    <button class="btn btn-outline-info" onclick="toggleAutoRefresh()">                        <i class="fas fa-play" id="auto-refresh-icon"></i> <span id="auto-refresh-text">Auto</span>                    </button>                </div>            </div>        </div>    </div>        <div class="row">        <!-- Mappa Principale -->        <div class="col-lg-9">            <div class="position-relative">                <div id="map"></div>                                <!-- Menu Hamburger -->                <button class="map-hamburger-btn" id="hamburger-btn" onclick="toggleMapPanel()">                    <i class="fas fa-bars" id="hamburger-icon"></i>                </button>            </div>                        <!-- Statistiche Rapide -->            <div class="row mt-3">                <div class="col-md-3">                    <div class="card bg-success text-white">                        <div class="card-body text-center p-2">                            <h4 id="online-count">0</h4>                            <small>Tecnici Online</small>                        </div>                    </div>                </div>                <div class="col-md-3">                    <div class="card bg-warning text-white">                        <div class="card-body text-center p-2">                            <h4 id="working-count">0</h4>                            <small>In Lavoro</small>                        </div>                    </div>                </div>                <div class="col-md-3">                    <div class="card bg-danger text-white">                        <div class="card-body text-center p-2">                            <h4 id="urgent-count">0</h4>                            <small>Ordini Urgenti</small>                        </div>                    </div>                </div>                <div class="col-md-3">                    <div class="card bg-primary text-white">                        <div class="card-body text-center p-2">                            <h4 id="pending-count">0</h4>                            <small>Da Assegnare</small>                        </div>                    </div>                </div>            </div>        </div>                <!-- Pannello Laterale -->        <div class="col-lg-3">            <!-- Tecnici Online con Drop Zones -->            <div class="card mb-3">                <div class="card-header bg-success text-white">                    <h6><i class="fas fa-users"></i> Tecnici (<span id="tech-count">0</span>)</h6>                    <small>Trascina ordini qui per assegnare</small>                </div>                <div class="card-body p-2 technician-info" id="technicians-list">                    <div class="text-center text-muted">                        <i class="fas fa-spinner fa-spin"></i> Caricamento...                    </div>                </div>            </div>                        <!-- Ordini Pendenti Trascinabili -->            <div class="card mb-3">                <div class="card-header bg-warning text-dark">                    <h6><i class="fas fa-clock"></i> Ordini Pendenti (<span id="orders-count">0</span>)</h6>                    <small>Trascina per assegnare ai tecnici</small>                </div>                <div class="card-body p-0 order-info" id="orders-list">                    <div class="text-center text-muted p-3">                        <i class="fas fa-spinner fa-spin"></i> Caricamento...                    </div>                </div>            </div>                        <!-- Azioni Rapide -->            <div class="card">                <div class="card-header bg-primary text-white">                    <h6><i class="fas fa-bolt"></i> Azioni Rapide</h6>                </div>                <div class="card-body p-2">                    <div class="d-grid gap-2">                        <button class="btn btn-primary btn-sm" onclick="showAssignModal()">                            <i class="fas fa-plus"></i> Nuovo Ordine                        </button>                        <button class="btn btn-outline-info btn-sm" onclick="optimizeRoutes()">                            <i class="fas fa-route"></i> Ottimizza Percorsi                        </button>                        <button class="btn btn-outline-secondary btn-sm" onclick="exportMapData()">                            <i class="fas fa-download"></i> Esporta Dati                        </button>                    </div>                </div>            </div>        </div>    </div></div><!-- Auto Refresh Indicator --><div class="auto-refresh-indicator" id="auto-refresh-indicator" style="display: none;">    <i class="fas fa-sync-alt fa-spin"></i> Aggiornamento automatico...</div><!-- Drop Indicator --><div class="drop-indicator" id="drop-indicator">    <i class="fas fa-check"></i> Rilascia per assegnare</div><!-- Modal Conferma Assegnazione --><div class="modal fade" id="confirmAssignModal" tabindex="-1">    <div class="modal-dialog">        <div class="modal-content">            <div class="modal-header">                <h5 class="modal-title"><i class="fas fa-question-circle"></i> Conferma Assegnazione</h5>                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>            </div>            <div class="modal-body" id="confirm-assign-content">                <!-- Contenuto dinamico -->            </div>            <div class="modal-footer">                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">                    <i class="fas fa-times"></i> Annulla                </button>                <button type="button" class="btn btn-primary" id="confirm-assign-btn">                    <i class="fas fa-check"></i> Conferma Assegnazione                </button>            </div>        </div>    </div></div>{% endblock %}{% block extra_js %}<!-- Leaflet JS --><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script>// Configurazione globaleconst MAP_CONFIG = {    center: [41.9028, 12.4964], // Roma come default    zoom: 12,    autoRefresh: false,    refreshInterval: 30000,    refreshTimer: null,    dragMode: false};// Variabili globalilet map;let techniciansLayer;let ordersLayer;let routesLayer;let baseLayers = {};let currentBaseLayer = null;let dragModeEnabled = false;let panelOpen = false;// Dati dal Django templateconst TECHNICIANS_DATA = {{ technicians_json|safe }};const ORDERS_DATA = {{ orders_json|safe }};const COMPANY_DATA = {{ company_json|safe }};// Variabili per drag & droplet draggedMarker = null;let originalPosition = null;let pendingAssignment = null;let markerPositions = new Map();let draggedOrderData = null;// Inizializzazionedocument.addEventListener('DOMContentLoaded', function() {    initializeMap();    setupBaseLayers();    loadInitialData();    updateStatistics();        // Inizializza drag & drop sidebar    initializeSidebarDragDrop();        // Chiudi pannello con ESC    document.addEventListener('keydown', function(e) {        if (e.key === 'Escape') {            if (panelOpen) closeMapPanel();            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmAssignModal'));            if (modal) modal.hide();        }    });});function initializeMap() {    try {        map = L.map('map', {            zoomControl: false        }).setView(MAP_CONFIG.center, MAP_CONFIG.zoom);                L.control.zoom({            position: 'bottomright'        }).addTo(map);                techniciansLayer = L.layerGroup().addTo(map);        ordersLayer = L.layerGroup().addTo(map);        routesLayer = L.layerGroup().addTo(map);                console.log('Mappa inizializzata');    } catch (error) {        console.error('Errore inizializzazione mappa:', error);        showNotification('Errore inizializzazione mappa', 'danger');    }}function setupBaseLayers() {    try {        baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {            attribution: '© OpenStreetMap contributors',            maxZoom: 19        });                baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {            attribution: 'Tiles © Esri',            maxZoom: 17        });                baseLayers.terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {            attribution: '© OpenTopoMap',            maxZoom: 17        });                baseLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {            attribution: '© CARTO',            subdomains: 'abcd',            maxZoom: 20        });                currentBaseLayer = baseLayers.osm;        currentBaseLayer.addTo(map);    } catch (error) {        console.error('Errore setup layers:', error);    }}function loadInitialData() {    try {        loadTechnicians();        loadOrders();        updateSidePanels();    } catch (error) {        console.error('Errore caricamento dati:', error);        showNotification('Errore nel caricamento dei dati', 'danger');    }}function loadTechnicians() {    techniciansLayer.clearLayers();    markerPositions.clear();        TECHNICIANS_DATA.forEach(technician => {        if (technician.lat && technician.lng) {            const marker = createTechnicianMarker(technician);            if (marker) {                techniciansLayer.addLayer(marker);                // Salva posizione originale                markerPositions.set(`tech-${technician.id}`, {                    lat: technician.lat,                    lng: technician.lng,                    data: technician                });            }        }    });}function createTechnicianMarker(technician) {    try {        let color = '#6c757d';        let icon = 'user-cog';                if (technician.is_active) {            if (technician.current_orders > 0) {                color = '#ffc107';                icon = 'user-clock';            } else {                color = '#28a745';                icon = 'user-check';            }        }                const markerIcon = L.divIcon({            className: 'technician-marker',            html: `                <div style="                    background-color: ${color};                    border: 3px solid white;                    border-radius: 50%;                    width: 35px;                    height: 35px;                    display: flex;                    align-items: center;                    justify-content: center;                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);                    cursor: pointer;                " class="tech-marker-${technician.id}" data-tech-id="${technician.id}">                    <i class="fas fa-${icon}" style="color: white; font-size: 14px;"></i>                </div>            `,            iconSize: [35, 35],            iconAnchor: [17, 17]        });                const marker = L.marker([technician.lat, technician.lng], {            icon: markerIcon,            title: technician.name,            draggable: true, // Riabilita drag per i marker            technicianId: technician.id        });                // Eventi drag per marker tecnici (verso marker ordini)        marker.on('dragstart', function(e) {            draggedMarker = this;            originalPosition = this.getLatLng();            this.setOpacity(0.7);            // Evidenzia i marker ordini            highlightOrderMarkers(true);        });                marker.on('drag', function(e) {            // Feedback visivo durante il drag            updateDragFeedback(e.latlng, 'tecnico');        });                marker.on('dragend', function(e) {            this.setOpacity(1);            highlightOrderMarkers(false);                        // Trova l'ordine più vicino            const closestOrder = findClosestOrderMarker(e.latlng);                        if (closestOrder && closestOrder.distance < 100) { // 100 metri di tolleranza                // Mostra lo stesso popup di conferma della sidebar                showAssignmentConfirmation(technician, closestOrder.order, 'map-drag');            }                        // SEMPRE torna alla posizione originale (effetto molla)            if (originalPosition) {                this.setLatLng(originalPosition);            }            draggedMarker = null;            originalPosition = null;        });                // Popup        const popupContent = `            <div class="technician-popup">                <h6><i class="fas fa-user-cog"></i> ${technician.name}</h6>                <p><strong>Telefono:</strong> ${technician.phone}</p>                <p><strong>Stato:</strong> ${technician.is_active ? 'Online' : 'Offline'}</p>                <p><strong>Ordini Attivi:</strong> ${technician.current_orders}</p>                <small class="text-muted">Usa la sidebar per assegnare ordini</small>            </div>        `;                marker.bindPopup(popupContent, {            maxWidth: 250,            className: 'technician-popup-container'        });                return marker;    } catch (error) {        console.error('Errore creazione marker tecnico:', error);        return null;    }}function loadOrders() {    ordersLayer.clearLayers();        ORDERS_DATA.forEach(order => {        if (order.lat && order.lng && order.status === 'PENDING') {            const marker = createOrderMarker(order);            if (marker) {                ordersLayer.addLayer(marker);                // Salva posizione originale                markerPositions.set(`order-${order.id}`, {                    lat: order.lat,                    lng: order.lng,                    data: order                });            }        }    });}function createOrderMarker(order) {    try {        let color = '#007bff';        let iconClass = 'clipboard-list';                switch(order.priority) {            case 'URGENT':                color = '#dc3545';                iconClass = 'exclamation-triangle';                break;            case 'HIGH':                color = '#fd7e14';                iconClass = 'exclamation';                break;            case 'LOW':                color = '#6c757d';                iconClass = 'clipboard';                break;        }                const markerIcon = L.divIcon({            className: 'order-marker',            html: `                <div style="                    background-color: ${color};                    border: 2px solid white;                    border-radius: 8px;                    width: 30px;                    height: 30px;                    display: flex;                    align-items: center;                    justify-content: center;                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);                    cursor: pointer;                " class="order-marker-${order.id}" data-order-id="${order.id}">                    <i class="fas fa-${iconClass}" style="color: white; font-size: 12px;"></i>                </div>            `,            iconSize: [30, 30],            iconAnchor: [15, 15]        });                const marker = L.marker([order.lat, order.lng], {            icon: markerIcon,            title: order.title,            draggable: true, // Riabilita drag per i marker            orderId: order.id        });                // Eventi drag per marker ordini (verso marker tecnici)        marker.on('dragstart', function(e) {            draggedMarker = this;            originalPosition = this.getLatLng();            this.setOpacity(0.7);            // Evidenzia i marker tecnici            highlightTechnicianMarkers(true);        });                marker.on('drag', function(e) {            // Feedback visivo durante il drag            updateDragFeedback(e.latlng, 'ordine');        });                marker.on('dragend', function(e) {            this.setOpacity(1);            highlightTechnicianMarkers(false);                        // Trova il tecnico più vicino            const closestTech = findClosestTechnicianMarker(e.latlng);                        if (closestTech && closestTech.distance < 100) { // 100 metri di tolleranza                // Mostra lo stesso popup di conferma della sidebar                showAssignmentConfirmation(closestTech.technician, order, 'map-drag');            }                        // SEMPRE torna alla posizione originale (effetto molla)            if (originalPosition) {                this.setLatLng(originalPosition);            }            draggedMarker = null;            originalPosition = null;        });                // Popup        const popupContent = `            <div class="order-popup">                <h6><i class="fas fa-clipboard-list"></i> ${order.order_number}</h6>                <p><strong>Cliente:</strong> ${order.customer_name}</p>                <p><strong>Priorità:</strong> ${order.priority_display}</p>                <p>${order.description ? order.description.substring(0, 100) + '...' : ''}</p>                <small class="text-muted">Usa la sidebar per assegnare a un tecnico</small>            </div>        `;                marker.bindPopup(popupContent, {            maxWidth: 280,            className: 'order-popup-container'        });                return marker;    } catch (error) {        console.error('Errore creazione marker ordine:', error);        return null;    }}// Inizializza drag & drop per sidebarfunction initializeSidebarDragDrop() {    // Rende le zone tecnici come drop zones    document.querySelectorAll('.technician-drop-zone').forEach(zone => {        zone.addEventListener('dragover', handleDragOver);        zone.addEventListener('drop', handleDropOnTechnician);        zone.addEventListener('dragenter', handleDragEnter);        zone.addEventListener('dragleave', handleDragLeave);    });        // Rende gli ordini trascinabili    document.querySelectorAll('.draggable-order').forEach(order => {        order.draggable = true;        order.addEventListener('dragstart', handleDragStart);        order.addEventListener('dragend', handleDragEnd);    });}function handleDragStart(e) {    const orderId = e.target.closest('.draggable-order').getAttribute('data-order-id');    const orderData = ORDERS_DATA.find(o => o.id === orderId);        draggedOrderData = orderData;    e.target.style.opacity = '0.5';    e.target.classList.add('dragging');        // Evidenzia le zone di drop    document.querySelectorAll('.technician-drop-zone').forEach(zone => {        zone.classList.add('drag-available');    });}function handleDragEnd(e) {    e.target.style.opacity = '1';    e.target.classList.remove('dragging');    draggedOrderData = null;        // Rimuovi evidenziazione    document.querySelectorAll('.technician-drop-zone').forEach(zone => {        zone.classList.remove('drag-available', 'drag-over');    });}function handleDragOver(e) {    e.preventDefault();}function handleDragEnter(e) {    e.preventDefault();    e.currentTarget.classList.add('drag-over');}function handleDragLeave(e) {    e.currentTarget.classList.remove('drag-over');}function handleDropOnTechnician(e) {    e.preventDefault();    e.currentTarget.classList.remove('drag-over');        if (!draggedOrderData) return;        const techId = e.currentTarget.getAttribute('data-tech-id');    const technician = TECHNICIANS_DATA.find(t => t.id == techId);        if (technician && technician.is_active) {        showAssignmentConfirmation(technician, draggedOrderData, 'sidebar-drag');    } else {        showNotification('Tecnico non disponibile', 'warning');    }}function showAssignmentConfirmation(technician, order, assignmentType) {    pendingAssignment = {        technician: technician,        order: order,        type: assignmentType    };        const distance = calculateDistance(        technician.lat, technician.lng,        order.lat, order.lng    );        const estimatedTime = Math.round(distance * 2);        const content = `        <div class="assignment-confirmation">            <div class="row">                <div class="col-6">                    <div class="card bg-light">                        <div class="card-body text-center p-2">                            <i class="fas fa-user-cog text-success fa-2x mb-2"></i>                            <h6>${technician.name}</h6>                            <small class="text-muted">                                ${technician.phone}<br>                                Ordini attivi: ${technician.current_orders}                            </small>                        </div>                    </div>                </div>                <div class="col-6">                    <div class="card bg-light">                        <div class="card-body text-center p-2">                            <i class="fas fa-clipboard-list text-warning fa-2x mb-2"></i>                            <h6>${order.order_number}</h6>                            <small class="text-muted">                                ${order.customer_name}<br>                                Priorità: ${order.priority_display}                            </small>                        </div>                    </div>                </div>            </div>            <div class="mt-3 text-center">                <p class="mb-1"><strong>Distanza stimata:</strong> ${distance.toFixed(1)} km</p>                <p class="mb-1"><strong>Tempo stimato:</strong> ~${estimatedTime} minuti</p>                <p class="text-info"><i class="fas fa-info-circle"></i> Assegnare questo ordine al tecnico?</p>            </div>        </div>    `;        document.getElementById('confirm-assign-content').innerHTML = content;        const modal = new bootstrap.Modal(document.getElementById('confirmAssignModal'));    modal.show();        // Setup pulsante conferma    const confirmBtn = document.getElementById('confirm-assign-btn');    confirmBtn.onclick = function() {        confirmAssignment();        modal.hide();    }}async function confirmAssignment() {    if (!pendingAssignment) return;        const { technician, order } = pendingAssignment;        try {        const response = await fetch('/api/assign-order/', {            method: 'POST',            headers: {                'Content-Type': 'application/json',                'X-CSRFToken': getCSRFToken()            },            body: JSON.stringify({                order_id: order.id,                technician_id: technician.id            })        });                const result = await response.json();                if (result.success) {            showNotification(result.message, 'success');                        // Animazione successo            animateSuccessAssignment(technician.id, order.id);                        // Aggiorna dati dopo 1 secondo            setTimeout(() => {                refreshMapData();            }, 1000);        } else {            showNotification(result.error || 'Errore nell\'assegnazione', 'danger');        }    } catch (error) {        console.error('Errore assegnazione:', error);        showNotification('Errore di connessione', 'danger');    }        pendingAssignment = null;}function animateSuccessAssignment(techId, orderId) {    // Anima marker tecnico    const techMarker = document.querySelector(`.tech-marker-${techId}`);    if (techMarker) {        techMarker.style.animation = 'successPulse 1s ease-out';        setTimeout(() => {            techMarker.style.animation = '';        }, 1000);    }        // Anima marker ordine    const orderMarker = document.querySelector(`.order-marker-${orderId}`);    if (orderMarker) {        orderMarker.style.animation = 'fadeOutScale 1s ease-out';        setTimeout(() => {            orderMarker.style.display = 'none';        }, 1000);    }}function updateSidePanels() {    updateTechniciansList();    updateOrdersList();}function updateTechniciansList() {    const container = document.getElementById('technicians-list');    const countEl = document.getElementById('tech-count');        if (!TECHNICIANS_DATA.length) {        container.innerHTML = '<div class="text-center text-muted py-3">Nessun tecnico disponibile</div>';        countEl.textContent = '0';        return;    }        let html = '';    TECHNICIANS_DATA.forEach(tech => {        const statusClass = tech.is_active ?             (tech.current_orders > 0 ? 'status-working' : 'status-online') :             'status-offline';                html += `            <div class="technician-drop-zone" data-tech-id="${tech.id}">                <div class="d-flex justify-content-between align-items-center">                    <h6 class="mb-0">${tech.name}</h6>                    <i class="fas fa-circle ${statusClass}"></i>                </div>                <small class="text-muted">                    ${tech.vehicle || 'Nessun veicolo'} • ${tech.current_orders} ordini                </small>                <div class="mt-1">                    <button class="btn btn-outline-primary btn-xs" onclick="focusOnTechnician(${tech.id})">                        <i class="fas fa-crosshairs"></i>                    </button>                </div>            </div>        `;    });        container.innerHTML = html;    countEl.textContent = TECHNICIANS_DATA.length;        // Re-inizializza drag & drop dopo aggiornamento    setTimeout(() => {        initializeSidebarDragDrop();    }, 100);}function updateOrdersList() {    const container = document.getElementById('orders-list');    const countEl = document.getElementById('orders-count');        const pendingOrders = ORDERS_DATA.filter(o => o.status === 'PENDING');        if (!pendingOrders.length) {        container.innerHTML = '<div class="text-center text-muted py-3">Tutti gli ordini sono assegnati!</div>';        countEl.textContent = '0';        return;    }        let html = '';    pendingOrders.forEach(order => {        const priorityClass = `order-${order.priority.toLowerCase()}`;                html += `            <div class="draggable-order-container">                <div class="draggable-order card mb-0 ${priorityClass}" data-order-id="${order.id}" draggable="true">                    <div class="card-body p-2">                        <div class="d-flex align-items-start">                            <div class="drag-handle">                                <i class="fas fa-grip-vertical"></i>                            </div>                            <div class="flex-grow-1">                                <h6 class="mb-1">${order.order_number}</h6>                                <p class="mb-1 small">${order.title}</p>                                <small class="text-muted">${order.customer_name}</small>                                <div class="mt-2">                                    <button class="btn btn-outline-primary btn-xs" onclick="focusOnOrder('${order.id}')">                                        <i class="fas fa-crosshairs"></i>                                    </button>                                </div>                            </div>                        </div>                    </div>                </div>            </div>        `;    });        container.innerHTML = html;    countEl.textContent = pendingOrders.length;        // Re-inizializza drag & drop dopo aggiornamento    setTimeout(() => {        initializeSidebarDragDrop();    }, 100);}function updateStatistics() {    const onlineCount = TECHNICIANS_DATA.filter(t => t.is_active).length;    const workingCount = TECHNICIANS_DATA.filter(t => t.current_orders > 0).length;    const urgentCount = ORDERS_DATA.filter(o => o.priority === 'URGENT' && o.status === 'PENDING').length;    const pendingCount = ORDERS_DATA.filter(o => o.status === 'PENDING').length;        document.getElementById('online-count').textContent = onlineCount;    document.getElementById('working-count').textContent = workingCount;    document.getElementById('urgent-count').textContent = urgentCount;    document.getElementById('pending-count').textContent = pendingCount;        if (panelOpen) {        document.getElementById('panel-online-count').textContent = onlineCount;        document.getElementById('panel-working-count').textContent = workingCount;        document.getElementById('panel-urgent-count').textContent = urgentCount;        document.getElementById('panel-pending-count').textContent = pendingCount;    }}// Funzioni pannellofunction toggleMapPanel() {    panelOpen ? closeMapPanel() : openMapPanel();}function openMapPanel() {    const panel = document.getElementById('control-panel');    const overlay = document.getElementById('panel-overlay');    const hamburgerBtn = document.getElementById('hamburger-btn');        panel.classList.add('active');    overlay.classList.add('active');    hamburgerBtn.classList.add('active');    document.getElementById('hamburger-icon').className = 'fas fa-times';    panelOpen = true;        updateStatistics();}function closeMapPanel() {    const panel = document.getElementById('control-panel');    const overlay = document.getElementById('panel-overlay');    const hamburgerBtn = document.getElementById('hamburger-btn');        panel.classList.remove('active');    overlay.classList.remove('active');    hamburgerBtn.classList.remove('active');    document.getElementById('hamburger-icon').className = 'fas fa-bars';    panelOpen = false;}function switchLayerFromPanel(layerName) {    document.querySelectorAll('input[name="mapLayerPanel"]').forEach(input => {        input.checked = input.value === layerName;        const option = input.closest('.layer-option');        option.classList.toggle('active', input.checked);    });        switchBaseLayer(layerName);}function switchBaseLayer(layerName) {    if (currentBaseLayer) {        map.removeLayer(currentBaseLayer);    }        currentBaseLayer = baseLayers[layerName];    if (currentBaseLayer) {        currentBaseLayer.addTo(map);        showNotification(`Mappa cambiata: ${layerName}`, 'info');    }}// Funzioni controllo mappafunction centerAllMarkers() {    const allMarkers = [];    techniciansLayer.eachLayer(layer => allMarkers.push(layer));    ordersLayer.eachLayer(layer => allMarkers.push(layer));        if (allMarkers.length > 0) {        const group = new L.featureGroup(allMarkers);        map.fitBounds(group.getBounds().pad(0.1));    }}function showOnlyTechnicians() {    ordersLayer.clearLayers();    loadTechnicians();    showNotification('Visualizzando solo tecnici', 'info');}function showOnlyOrders() {    techniciansLayer.clearLayers();    loadOrders();    showNotification('Visualizzando solo ordini', 'info');}function showAll() {    loadTechnicians();    loadOrders();    showNotification('Visualizzando tutto', 'info');}function toggleDragMode() {    dragModeEnabled = !dragModeEnabled;    const btn = document.getElementById('drag-mode-panel-btn');    btn.classList.toggle('active', dragModeEnabled);    showNotification(dragModeEnabled ? 'Modalità drag attivata' : 'Modalità drag disattivata', 'info');}// Funzioni refreshasync function refreshMapData() {    const refreshIcon = document.getElementById('refresh-icon');    if (refreshIcon) refreshIcon.classList.add('fa-spin');        try {        const response = await fetch('/api/map-data/');        const data = await response.json();                TECHNICIANS_DATA.length = 0;        TECHNICIANS_DATA.push(...(data.technicians || []));                ORDERS_DATA.length = 0;        ORDERS_DATA.push(...(data.orders || []));                loadInitialData();        updateStatistics();                showNotification('Dati aggiornati!', 'success');    } catch (error) {        console.error('Errore refresh:', error);        showNotification('Errore aggiornamento dati', 'danger');    } finally {        if (refreshIcon) refreshIcon.classList.remove('fa-spin');    }}function toggleAutoRefresh() {    MAP_CONFIG.autoRefresh = !MAP_CONFIG.autoRefresh;    const icon = document.getElementById('auto-refresh-icon');    const text = document.getElementById('auto-refresh-text');    const indicator = document.getElementById('auto-refresh-indicator');        if (MAP_CONFIG.autoRefresh) {        icon.className = 'fas fa-pause';        text.textContent = 'Stop';        indicator.style.display = 'block';                MAP_CONFIG.refreshTimer = setInterval(refreshMapData, MAP_CONFIG.refreshInterval);        showNotification('Auto-refresh attivato', 'info');    } else {        icon.className = 'fas fa-play';        text.textContent = 'Auto';        indicator.style.display = 'none';                if (MAP_CONFIG.refreshTimer) {            clearInterval(MAP_CONFIG.refreshTimer);        }        showNotification('Auto-refresh disattivato', 'warning');    }}// Funzioni focusfunction focusOnTechnician(techId) {    const tech = TECHNICIANS_DATA.find(t => t.id === techId);    if (tech && tech.lat && tech.lng) {        map.setView([tech.lat, tech.lng], 16);                techniciansLayer.eachLayer(layer => {            if (layer.options.technicianId === techId) {                layer.openPopup();            }        });    }}function focusOnOrder(orderId) {    const order = ORDERS_DATA.find(o => o.id === orderId);    if (order && order.lat && order.lng) {        map.setView([order.lat, order.lng], 16);                ordersLayer.eachLayer(layer => {            if (layer.options.orderId === orderId) {                layer.openPopup();            }        });    }}// Utilitàfunction calculateDistance(lat1, lng1, lat2, lng2) {    const R = 6371;    const dLat = (lat2 - lat1) * Math.PI / 180;    const dLng = (lng2 - lng1) * Math.PI / 180;    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *              Math.sin(dLng/2) * Math.sin(dLng/2);    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));    return R * c;}function showNotification(message, type = 'info') {    const notification = document.createElement('div');    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;    notification.style.cssText = `        top: 20px;        right: 20px;        z-index: 9999;        min-width: 300px;        box-shadow: 0 4px 8px rgba(0,0,0,0.1);    `;    notification.innerHTML = `        ${message}        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>    `;        document.body.appendChild(notification);        setTimeout(() => {        if (notification.parentNode) {            notification.remove();        }    }, 3000);}function getCSRFToken() {    const name = 'csrftoken';    let cookieValue = null;    if (document.cookie && document.cookie !== '') {        const cookies = document.cookie.split(';');        for (let i = 0; i < cookies.length; i++) {            const cookie = cookies[i].trim();            if (cookie.substring(0, name.length + 1) === (name + '=')) {                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));                break;            }        }    }    return cookieValue;}// Funzioni stubfunction showAssignModal() {    window.location.href = '/orders/create/';}function optimizeRoutes() {    showNotification('Ottimizzazione percorsi in sviluppo!', 'info');}function exportMapData() {    const data = {        technicians: TECHNICIANS_DATA,        orders: ORDERS_DATA,        timestamp: new Date().toISOString()    };        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});    const url = URL.createObjectURL(blob);    const a = document.createElement('a');    a.href = url;    a.download = `map_data_${new Date().toISOString().split('T')[0]}.json`;    a.click();    URL.revokeObjectURL(url);        showNotification('Dati esportati!', 'success');}// Cleanupwindow.addEventListener('beforeunload', function() {    if (MAP_CONFIG.refreshTimer) {        clearInterval(MAP_CONFIG.refreshTimer);    }});</script><style>/* Animazioni per successo assegnazione */@keyframes successPulse {    0% {        transform: scale(1);        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);    }    50% {        transform: scale(1.2);        box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);    }    100% {        transform: scale(1);        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);    }}@keyframes fadeOutScale {    0% {        transform: scale(1);        opacity: 1;    }    100% {        transform: scale(0);        opacity: 0;    }}@keyframes pulse {    0% {        transform: scale(1);    }    50% {        transform: scale(1.1);    }    100% {        transform: scale(1);    }}/* Fix per marker draggable */.leaflet-marker-draggable {    cursor: pointer !important;}/* Stili per popup conferma */.assignment-confirmation .card {    border: none;    box-shadow: 0 2px 4px rgba(0,0,0,0.1);}.assignment-confirmation .card-body {    min-height: 120px;}/* Fix per z-index modali */.modal {    z-index: 10000;}.modal-backdrop {    z-index: 9999;}/* Stili per drag & drop sidebar */.drag-available {    border: 2px dashed #007bff !important;    background: rgba(0, 123, 255, 0.1) !important;    transition: all 0.3s ease;}.drag-over {    border: 2px solid #28a745 !important;    background: rgba(40, 167, 69, 0.2) !important;    transform: scale(1.02);    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);}.dragging {    opacity: 0.5 !important;    transform: rotate(2deg) !important;    z-index: 1000;    box-shadow: 0 8px 25px rgba(0,0,0,0.3) !important;}.drag-handle {    cursor: grab;    color: #6c757d;    margin-right: 8px;    padding: 2px;    transition: all 0.2s ease;}.drag-handle:hover {    color: #495057;    transform: scale(1.1);}.drag-handle:active {    cursor: grabbing;    transform: scale(0.95);}.draggable-order:hover .drag-handle {    color: #007bff;}</style>{% endblock %}