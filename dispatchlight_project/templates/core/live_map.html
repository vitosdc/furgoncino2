{% extends 'base.html' %}{% block title %}Mappa Live - DispatchLight{% endblock %}{% block extra_css %}<!-- Leaflet CSS --><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" /><!-- Sortable.js per drag & drop --><script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>{% endblock %}{% block content %}<div class="container-fluid">    <!-- Pannello Controlli Scorrevole -->    <div class="map-panel-overlay" id="panel-overlay" onclick="closeMapPanel()"></div>    <div class="map-control-panel" id="control-panel">        <div class="panel-header">            <h5><i class="fas fa-map-marked-alt"></i> Controlli Mappa Live</h5>            <button class="panel-close-btn" onclick="closeMapPanel()">                <i class="fas fa-times"></i>            </button>        </div>        <div class="panel-content">                        <!-- Sezione Layer Mappa -->            <div class="panel-section">                <h6><i class="fas fa-layers"></i> Tipo di Mappa</h6>                <div class="layer-option" onclick="switchLayerFromPanel('osm')">                    <input type="radio" id="layer-osm-panel" name="mapLayerPanel" value="osm" checked>                    <label for="layer-osm-panel">Stradale Standard</label>                </div>                <div class="layer-option" onclick="switchLayerFromPanel('satellite')">                    <input type="radio" id="layer-satellite-panel" name="mapLayerPanel" value="satellite">                    <label for="layer-satellite-panel">Satellite</label>                </div>                <div class="layer-option" onclick="switchLayerFromPanel('terrain')">                    <input type="radio" id="layer-terrain-panel" name="mapLayerPanel" value="terrain">                    <label for="layer-terrain-panel">Terreno</label>                </div>                <div class="layer-option" onclick="switchLayerFromPanel('dark')">                    <input type="radio" id="layer-dark-panel" name="mapLayerPanel" value="dark">                    <label for="layer-dark-panel">Modalità Scura</label>                </div>            </div>            <!-- Sezione Controlli Vista -->            <div class="panel-section">                <h6><i class="fas fa-eye"></i> Controlli Vista</h6>                <div class="action-controls">                    <button class="control-btn" onclick="showOnlyTechnicians()">                        <i class="fas fa-user-cog"></i>                        Mostra Solo Tecnici                    </button>                    <button class="control-btn" onclick="showOnlyOrders()">                        <i class="fas fa-clipboard-list"></i>                        Mostra Solo Ordini                    </button>                    <button class="control-btn" onclick="showAll()">                        <i class="fas fa-eye"></i>                        Mostra Tutto                    </button>                    <button class="control-btn" id="drag-mode-panel-btn" onclick="toggleDragMode()">                        <i class="fas fa-hand-rock"></i>                        Modalità Trascinamento                    </button>                    <button class="control-btn" onclick="centerAllMarkers()">                        <i class="fas fa-expand-arrows-alt"></i>                        Centra Mappa                    </button>                </div>            </div>            <!-- Sezione Legenda -->            <div class="panel-section">                <h6><i class="fas fa-info-circle"></i> Legenda Simboli</h6>                <div class="panel-legend">                    <div class="legend-item">                        <div class="legend-icon bg-success"></div>                        <span class="legend-text">Tecnico Libero</span>                    </div>                    <div class="legend-item">                        <div class="legend-icon bg-warning"></div>                        <span class="legend-text">Tecnico Occupato</span>                    </div>                    <div class="legend-item">                        <div class="legend-icon bg-primary"></div>                        <span class="legend-text">In Viaggio</span>                    </div>                    <div class="legend-item">                        <div class="legend-icon bg-secondary"></div>                        <span class="legend-text">Offline</span>                    </div>                    <div class="legend-item">                        <div class="legend-icon bg-danger"></div>                        <span class="legend-text">Ordini Urgenti</span>                    </div>                </div>            </div>            <!-- Statistiche Live -->            <div class="panel-section">                <h6><i class="fas fa-chart-bar"></i> Statistiche Live</h6>                <div class="panel-stats">                    <div class="stat-item">                        <div class="stat-number" id="panel-online-count">0</div>                        <div class="stat-label">Online</div>                    </div>                    <div class="stat-item">                        <div class="stat-number" id="panel-working-count">0</div>                        <div class="stat-label">Al Lavoro</div>                    </div>                    <div class="stat-item">                        <div class="stat-number" id="panel-urgent-count">0</div>                        <div class="stat-label">Urgenti</div>                    </div>                    <div class="stat-item">                        <div class="stat-number" id="panel-pending-count">0</div>                        <div class="stat-label">Da Assegnare</div>                    </div>                </div>            </div>            <!-- Sezione Azioni -->            <div class="panel-section">                <h6><i class="fas fa-bolt"></i> Azioni Rapide</h6>                <div class="action-controls">                    <button class="control-btn" onclick="refreshMapData()">                        <i class="fas fa-sync-alt"></i>                        Aggiorna Dati                    </button>                    <button class="control-btn" onclick="toggleAutoRefresh()" id="auto-refresh-panel-btn">                        <i class="fas fa-play"></i>                        Auto Refresh                    </button>                    <button class="control-btn" onclick="optimizeRoutes()">                        <i class="fas fa-route"></i>                        Ottimizza Percorsi                    </button>                    <button class="control-btn" onclick="exportMapData()">                        <i class="fas fa-download"></i>                        Esporta Dati                    </button>                </div>            </div>        </div>    </div>    <div class="row">        <div class="col-12">            <div class="d-flex justify-content-between align-items-center mb-3">                <h1><i class="fas fa-map-marked-alt"></i> Mappa Live</h1>                <div class="btn-group">                    <button class="btn btn-outline-primary" onclick="centerAllMarkers()">                        <i class="fas fa-expand-arrows-alt"></i> Centra Tutto                    </button>                    <button class="btn btn-outline-success" onclick="refreshMapData()">                        <i class="fas fa-sync-alt" id="refresh-icon"></i> Aggiorna                    </button>                    <button class="btn btn-outline-info" onclick="toggleAutoRefresh()">                        <i class="fas fa-play" id="auto-refresh-icon"></i> <span id="auto-refresh-text">Auto</span>                    </button>                </div>            </div>        </div>    </div>        <div class="row">        <!-- Mappa Principale -->        <div class="col-lg-9">            <div class="position-relative">                <div id="map"></div>                                <!-- Menu Hamburger -->                <button class="map-hamburger-btn" id="hamburger-btn" onclick="toggleMapPanel()">                    <i class="fas fa-bars" id="hamburger-icon"></i>                </button>            </div>                        <!-- Statistiche Rapide -->            <div class="row mt-3">                <div class="col-md-3">                    <div class="card bg-success text-white">                        <div class="card-body text-center p-2">                            <h4 id="online-count">0</h4>                            <small>Tecnici Online</small>                        </div>                    </div>                </div>                <div class="col-md-3">                    <div class="card bg-warning text-white">                        <div class="card-body text-center p-2">                            <h4 id="working-count">0</h4>                            <small>In Lavoro</small>                        </div>                    </div>                </div>                <div class="col-md-3">                    <div class="card bg-danger text-white">                        <div class="card-body text-center p-2">                            <h4 id="urgent-count">0</h4>                            <small>Ordini Urgenti</small>                        </div>                    </div>                </div>                <div class="col-md-3">                    <div class="card bg-primary text-white">                        <div class="card-body text-center p-2">                            <h4 id="pending-count">0</h4>                            <small>Da Assegnare</small>                        </div>                    </div>                </div>            </div>        </div>                <!-- Pannello Laterale -->        <div class="col-lg-3">            <!-- Tecnici Online con Drop Zones -->            <div class="card mb-3">                <div class="card-header bg-success text-white">                    <h6><i class="fas fa-users"></i> Tecnici (<span id="tech-count">0</span>)</h6>                    <small>Trascina ordini qui per assegnare</small>                </div>                <div class="card-body p-2 technician-info" id="technicians-list">                    <div class="text-center text-muted">                        <i class="fas fa-spinner fa-spin"></i> Caricamento...                    </div>                </div>            </div>                        <!-- Ordini Pendenti Trascinabili -->            <div class="card mb-3">                <div class="card-header bg-warning text-dark">                    <h6><i class="fas fa-clock"></i> Ordini Pendenti (<span id="orders-count">0</span>)</h6>                    <small>Trascina per assegnare ai tecnici</small>                </div>                <div class="card-body p-0 order-info" id="orders-list">                    <div class="text-center text-muted p-3">                        <i class="fas fa-spinner fa-spin"></i> Caricamento...                    </div>                </div>            </div>                        <!-- Azioni Rapide -->            <div class="card">                <div class="card-header bg-primary text-white">                    <h6><i class="fas fa-bolt"></i> Azioni Rapide</h6>                </div>                <div class="card-body p-2">                    <div class="d-grid gap-2">                        <button class="btn btn-primary btn-sm" onclick="showAssignModal()">                            <i class="fas fa-plus"></i> Nuovo Ordine                        </button>                        <button class="btn btn-outline-info btn-sm" onclick="optimizeRoutes()">                            <i class="fas fa-route"></i> Ottimizza Percorsi                        </button>                        <button class="btn btn-outline-secondary btn-sm" onclick="exportMapData()">                            <i class="fas fa-download"></i> Esporta Dati                        </button>                    </div>                </div>            </div>        </div>    </div></div><!-- Auto Refresh Indicator --><div class="auto-refresh-indicator" id="auto-refresh-indicator" style="display: none;">    <i class="fas fa-sync-alt fa-spin"></i> Aggiornamento automatico...</div><!-- Drop Indicator --><div class="drop-indicator" id="drop-indicator">    <i class="fas fa-check"></i> Rilascia per assegnare</div><!-- Modal Assegnazione Rapida --><div class="modal fade quick-assign-modal" id="quickAssignModal" tabindex="-1">    <div class="modal-dialog">        <div class="modal-content">            <div class="modal-header">                <h5 class="modal-title"><i class="fas fa-bolt"></i> Assegnazione Rapida</h5>                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>            </div>            <div class="modal-body">                <div id="assign-content">                    <p>Seleziona un ordine dalla mappa e un tecnico disponibile per l'assegnazione rapida.</p>                </div>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>                <button type="button" class="btn btn-primary" onclick="confirmAssignment()">                    <i class="fas fa-check"></i> Conferma Assegnazione                </button>            </div>        </div>    </div></div><!-- Modal Dettagli --><div class="modal fade" id="detailsModal" tabindex="-1">    <div class="modal-dialog modal-lg">        <div class="modal-content">            <div class="modal-header">                <h5 class="modal-title" id="details-title">Dettagli</h5>                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>            </div>            <div class="modal-body" id="details-content">                <!-- Contenuto dinamico -->            </div>        </div>    </div></div>{% endblock %}{% block extra_js %}<!-- Leaflet JS --><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script><script>// Configurazione globaleconst MAP_CONFIG = {    center: [41.9028, 12.4964], // Roma come default    zoom: 12,    autoRefresh: false,    refreshInterval: 30000, // 30 secondi    refreshTimer: null,    dragMode: false};// Variabili globalilet map;let techniciansLayer;let ordersLayer;let routesLayer;let selectedOrder = null;let selectedTechnician = null;let currentBaseLayer = null;let baseLayers = {};let dragModeEnabled = false;let panelOpen = false;// Dati dal Django templateconst TECHNICIANS_DATA = {{ technicians_json|safe }};const ORDERS_DATA = {{ orders_json|safe }};const COMPANY_DATA = {{ company_json|safe }};// Gestione Menu Hamburger e Pannellofunction toggleMapPanel() {    if (panelOpen) {        closeMapPanel();    } else {        openMapPanel();    }}function openMapPanel() {    const panel = document.getElementById('control-panel');    const overlay = document.getElementById('panel-overlay');    const hamburgerBtn = document.getElementById('hamburger-btn');    const hamburgerIcon = document.getElementById('hamburger-icon');        panel.classList.add('active');    overlay.classList.add('active');    hamburgerBtn.classList.add('active');    hamburgerIcon.className = 'fas fa-times';    panelOpen = true;        // Aggiorna le statistiche nel pannello    updatePanelStats();}function closeMapPanel() {    const panel = document.getElementById('control-panel');    const overlay = document.getElementById('panel-overlay');    const hamburgerBtn = document.getElementById('hamburger-btn');    const hamburgerIcon = document.getElementById('hamburger-icon');        panel.classList.remove('active');    overlay.classList.remove('active');    hamburgerBtn.classList.remove('active');    hamburgerIcon.className = 'fas fa-bars';    panelOpen = false;}function switchLayerFromPanel(layerName) {    // Aggiorna i radio button nel pannello    document.querySelectorAll('input[name="mapLayerPanel"]').forEach(input => {        input.checked = input.value === layerName;        const option = input.closest('.layer-option');        if (input.checked) {            option.classList.add('active');        } else {            option.classList.remove('active');        }    });        // Cambia il layer della mappa    switchBaseLayer(layerName);}function updatePanelStats() {    // Aggiorna le statistiche nel pannello    const onlineCount = TECHNICIANS_DATA.filter(t => t.is_active).length;    const workingCount = TECHNICIANS_DATA.filter(t => t.current_orders > 0).length;    const urgentCount = ORDERS_DATA.filter(o => o.priority === 'URGENT').length;    const pendingCount = ORDERS_DATA.length;    document.getElementById('panel-online-count').textContent = onlineCount;    document.getElementById('panel-working-count').textContent = workingCount;    document.getElementById('panel-urgent-count').textContent = urgentCount;    document.getElementById('panel-pending-count').textContent = pendingCount;}// Inizializzazione mappadocument.addEventListener('DOMContentLoaded', function() {    initializeMap();    setupBaseLayers();    loadInitialData();    updateStatistics();    setupDragAndDrop();        // Chiudi pannello con ESC    document.addEventListener('keydown', function(e) {        if (e.key === 'Escape' && panelOpen) {            closeMapPanel();        }    });});function initializeMap() {    // Inizializza la mappa DISABILITANDO il controllo zoom predefinito    map = L.map('map', {        zoomControl: false  // ← Questo disabilita il controllo predefinito    }).setView(MAP_CONFIG.center, MAP_CONFIG.zoom);        // Aggiungi manualmente il controllo zoom A DESTRA IN ALTO    L.control.zoom({        position: 'bottomright'  // ← Questo lo posiziona a destra    }).addTo(map);        // Inizializza i layer    techniciansLayer = L.layerGroup().addTo(map);    ordersLayer = L.layerGroup().addTo(map);    routesLayer = L.layerGroup().addTo(map);        console.log('Mappa inizializzata');}function setupBaseLayers() {    // OpenStreetMap (default)    baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {        attribution: '© OpenStreetMap contributors',        maxZoom: 19    });        // Satellite (Esri World Imagery)    baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {        attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',        maxZoom: 17    });        // Terrain (OpenTopoMap)    baseLayers.terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {        attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)',        maxZoom: 17    });        // Dark Mode (CartoDB Dark)    baseLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',        subdomains: 'abcd',        maxZoom: 20    });        // Imposta layer di default    currentBaseLayer = baseLayers.osm;    currentBaseLayer.addTo(map);}function switchBaseLayer(layerName) {    if (currentBaseLayer) {        map.removeLayer(currentBaseLayer);    }        currentBaseLayer = baseLayers[layerName];    if (currentBaseLayer) {        currentBaseLayer.addTo(map);    }        // Feedback visivo    showNotification(`Layer cambiato: ${getLayerDisplayName(layerName)}`, 'info');}function getLayerDisplayName(layerName) {    const names = {        osm: 'Stradale',        satellite: 'Satellite',         terrain: 'Terreno',        dark: 'Scuro'    };    return names[layerName] || layerName;}// Setup Drag & Dropfunction setupDragAndDrop() {    // Rendi i tecnici drop zones    setupTechnicianDropZones();        // Setup ordini trascinabili    setupDraggableOrders();        // Setup drag & drop su mappa    setupMapDragDrop();}function setupTechnicianDropZones() {    // Viene chiamata quando aggiorni la lista tecnici    // Implementata in updateTechniciansList()}function setupDraggableOrders() {    const ordersContainer = document.getElementById('orders-list');        if (ordersContainer && typeof Sortable !== 'undefined') {        new Sortable(ordersContainer, {            group: {                name: 'orders',                pull: 'clone',                put: false            },            sort: false,            animation: 150,            ghostClass: 'dragging',            chosenClass: 'dragging',            onStart: function(evt) {                dragModeEnabled = true;                document.body.style.cursor = 'grabbing';                                // Evidenzia tecnici disponibili                highlightAvailableTechnicians(true);                                // Mostra indicatore drag                showDragIndicator();            },            onEnd: function(evt) {                dragModeEnabled = false;                document.body.style.cursor = '';                                // Rimuovi evidenziazioni                highlightAvailableTechnicians(false);                                // Nascondi indicatore                hideDragIndicator();            }        });    }}function setupMapDragDrop() {    // Abilita drag sui marker degli ordini    ordersLayer.eachLayer(marker => {        if (marker.dragging) {            marker.dragging.enable();        }    });        // Setup drop zone su marker tecnici    techniciansLayer.eachLayer(marker => {        marker.on('dragover', handleTechnicianDragOver);        marker.on('drop', handleTechnicianDrop);    });}function loadInitialData() {    // Carica tecnici    loadTechnicians();        // Carica ordini    loadOrders();        // Aggiorna pannelli laterali    updateSidePanels();}function loadTechnicians() {    // Pulisci layer esistente    techniciansLayer.clearLayers();        TECHNICIANS_DATA.forEach(technician => {        if (technician.lat && technician.lng) {            const marker = createTechnicianMarker(technician);            techniciansLayer.addLayer(marker);        }    });        console.log(`Caricati ${TECHNICIANS_DATA.length} tecnici`);}function createTechnicianMarker(technician) {    // Determina colore basato su stato    let color = '#6c757d'; // offline    let icon = 'user-cog';        if (technician.is_active) {        if (technician.current_orders > 0) {            color = '#ffc107'; // occupato            icon = 'user-clock';        } else {            color = '#28a745'; // libero            icon = 'user-check';        }    }        // Crea icona personalizzata    const markerIcon = L.divIcon({        className: 'technician-marker',        html: `            <div style="                background-color: ${color};                border: 3px solid white;                border-radius: 50%;                width: 30px;                height: 30px;                display: flex;                align-items: center;                justify-content: center;                box-shadow: 0 2px 5px rgba(0,0,0,0.3);                ${technician.is_active ? 'animation: pulse 2s infinite;' : ''}            " class="tech-marker-${technician.id}" data-tech-id="${technician.id}">                <i class="fas fa-${icon}" style="color: white; font-size: 12px;"></i>            </div>        `,        iconSize: [30, 30],        iconAnchor: [15, 15]    });        const marker = L.marker([technician.lat, technician.lng], {        icon: markerIcon,        title: technician.name,        technicianId: technician.id    });        // Setup drop zone sul marker    marker.getElement = function() {        return document.querySelector(`.tech-marker-${technician.id}`);    };        // Popup con informazioni    const popupContent = `        <div class="technician-popup">            <h6><i class="fas fa-user-cog"></i> ${technician.name}</h6>            <p class="mb-1">                <strong>Stato:</strong>                 <span class="badge bg-${technician.is_active ? 'success' : 'secondary'}">                    ${technician.is_active ? 'Online' : 'Offline'}                </span>            </p>            <p class="mb-1"><strong>Telefono:</strong> ${technician.phone}</p>            <p class="mb-1"><strong>Veicolo:</strong> ${technician.vehicle || 'N/A'}</p>            <p class="mb-2"><strong>Ordini Attivi:</strong> ${technician.current_orders}</p>            <div class="btn-group btn-group-sm">                <button class="btn btn-outline-primary" onclick="showTechnicianDetails(${technician.id})">                    <i class="fas fa-info"></i> Dettagli                </button>                <button class="btn btn-outline-success" onclick="selectTechnicianForAssignment(${technician.id})">                    <i class="fas fa-hand-pointer"></i> Seleziona                </button>            </div>        </div>    `;        marker.bindPopup(popupContent, {        maxWidth: 250,        className: 'technician-popup-container'    });        // Click handler per selezione    marker.on('click', function() {        selectTechnician(technician);    });        return marker;}function loadOrders() {    // Pulisci layer esistente    ordersLayer.clearLayers();        ORDERS_DATA.forEach(order => {        if (order.lat && order.lng) {            const marker = createOrderMarker(order);            ordersLayer.addLayer(marker);        }    });        console.log(`Caricati ${ORDERS_DATA.length} ordini`);}function createOrderMarker(order) {    // Colore basato su priorità    let color = '#007bff'; // normale    let iconClass = 'clipboard-list';        switch(order.priority) {        case 'URGENT':            color = '#dc3545';            iconClass = 'exclamation-triangle';            break;        case 'HIGH':            color = '#fd7e14';            iconClass = 'exclamation';            break;        case 'LOW':            color = '#6c757d';            iconClass = 'clipboard';            break;    }        // Crea icona personalizzata    const markerIcon = L.divIcon({        className: 'order-marker',        html: `            <div style="                background-color: ${color};                border: 2px solid white;                border-radius: 8px;                width: 25px;                height: 25px;                display: flex;                align-items: center;                justify-content: center;                box-shadow: 0 2px 5px rgba(0,0,0,0.3);                ${order.priority === 'URGENT' ? 'animation: pulse 1s infinite;' : ''}            " class="order-marker-${order.id}" data-order-id="${order.id}">                <i class="fas fa-${iconClass}" style="color: white; font-size: 10px;"></i>            </div>        `,        iconSize: [25, 25],        iconAnchor: [12, 12]    });        const marker = L.marker([order.lat, order.lng], {        icon: markerIcon,        title: order.title,        draggable: true, // Abilita drag sui marker ordini        orderId: order.id    });        // Setup drag events sul marker    marker.on('dragstart', function(e) {        this.setOpacity(0.7);        highlightAvailableTechnicians(true);        showDragIndicator();    });        marker.on('drag', function(e) {        updateDropIndicatorPosition(e.latlng);    });        marker.on('dragend', function(e) {        this.setOpacity(1);        highlightAvailableTechnicians(false);        hideDragIndicator();                // Controlla se rilasciato su un tecnico        checkDropOnTechnician(e.latlng, order);    });        // Popup con informazioni ordine    const popupContent = `        <div class="order-popup">            <h6><i class="fas fa-clipboard-list"></i> ${order.order_number}</h6>            <p class="mb-1"><strong>${order.title}</strong></p>            <p class="mb-1">                <strong>Cliente:</strong> ${order.customer_name}            </p>            <p class="mb-1">                <strong>Priorità:</strong>                 <span class="badge bg-${order.priority === 'URGENT' ? 'danger' : order.priority === 'HIGH' ? 'warning' : order.priority === 'LOW' ? 'secondary' : 'primary'}">                    ${order.priority_display}                </span>            </p>            <p class="mb-1">                <strong>Creato:</strong> ${formatDate(order.created_at)}            </p>            <p class="mb-2 small">${order.description.substring(0, 100)}...</p>            <div class="btn-group btn-group-sm">                <button class="btn btn-outline-primary" onclick="showOrderDetails('${order.id}')">                    <i class="fas fa-info"></i> Dettagli                </button>                <button class="btn btn-outline-warning" onclick="selectOrderForAssignment('${order.id}')">                    <i class="fas fa-hand-pointer"></i> Seleziona                </button>            </div>        </div>    `;        marker.bindPopup(popupContent, {        maxWidth: 280,        className: 'order-popup-container'    });        // Click handler per selezione    marker.on('click', function() {        selectOrder(order);    });        return marker;}// Drag & Drop Functionsfunction highlightAvailableTechnicians(highlight) {    const techElements = document.querySelectorAll('.technician-drop-zone');    const techMarkers = document.querySelectorAll('.technician-marker > div');        if (highlight) {        techElements.forEach(el => el.classList.add('drag-over'));        techMarkers.forEach(el => el.style.boxShadow = '0 0 15px rgba(40, 167, 69, 0.8)');    } else {        techElements.forEach(el => el.classList.remove('drag-over'));        techMarkers.forEach(el => el.style.boxShadow = '0 2px 5px rgba(0,0,0,0.3)');    }}function showDragIndicator() {    const indicator = document.getElementById('drop-indicator');    indicator.classList.add('show');}function hideDragIndicator() {    const indicator = document.getElementById('drop-indicator');    indicator.classList.remove('show');}function updateDropIndicatorPosition(latlng) {    const indicator = document.getElementById('drop-indicator');    const point = map.latLngToContainerPoint(latlng);        indicator.style.left = (point.x + 20) + 'px';    indicator.style.top = (point.y - 10) + 'px';}function checkDropOnTechnician(latlng, order) {    let closestTechnician = null;    let minDistance = Infinity;        // Trova il tecnico più vicino al punto di rilascio    TECHNICIANS_DATA.forEach(tech => {        if (tech.lat && tech.lng && tech.is_active) {            const distance = map.distance(latlng, [tech.lat, tech.lng]);            if (distance < minDistance && distance < 100) { // 100 metri di tolleranza                minDistance = distance;                closestTechnician = tech;            }        }    });        if (closestTechnician) {        // Assegna automaticamente        assignOrderToTechnician(order.id, closestTechnician.id);    }}async function assignOrderToTechnician(orderId, technicianId) {    try {        // Chiama API di assegnazione        const response = await fetch('/api/assign-order/', {            method: 'POST',            headers: {                'Content-Type': 'application/json',                'X-CSRFToken': getCSRFToken()            },            body: JSON.stringify({                order_id: orderId,                technician_id: technicianId            })        });                const result = await response.json();                if (result.success) {            showNotification(result.message, 'success');                        // Animazione successo            const techElement = document.querySelector(`.tech-marker-${technicianId}`);            if (techElement) {                techElement.parentElement.classList.add('drag-success');                setTimeout(() => {                    techElement.parentElement.classList.remove('drag-success');                }, 500);            }                        // Aggiorna dati            await refreshMapData();        } else {            showNotification(result.error || 'Errore nell\'assegnazione', 'danger');        }            } catch (error) {        console.error('Errore assegnazione:', error);        showNotification('Errore nell\'assegnazione dell\'ordine', 'danger');    }}function updateSidePanels() {    updateTechniciansList();    updateOrdersList();}function updateTechniciansList() {    const container = document.getElementById('technicians-list');    const countEl = document.getElementById('tech-count');        if (!TECHNICIANS_DATA.length) {        container.innerHTML = `            <div class="text-center text-muted py-3">                <i class="fas fa-user-slash"></i>                <p class="mb-0">Nessun tecnico disponibile</p>            </div>        `;        countEl.textContent = '0';        return;    }        let html = '';    TECHNICIANS_DATA.forEach(tech => {        const statusClass = tech.is_active ?             (tech.current_orders > 0 ? 'status-working' : 'status-online') :             'status-offline';                html += `            <div class="technician-drop-zone" data-tech-id="${tech.id}">                <div class="d-flex justify-content-between align-items-center">                    <h6 class="mb-0">${tech.name}</h6>                    <i class="fas fa-circle ${statusClass}"></i>                </div>                <small class="text-muted">                    ${tech.vehicle || 'Nessun veicolo'} • ${tech.current_orders} ordini                </small>                <div class="mt-1">                    <button class="btn btn-outline-primary btn-xs me-1"                             onclick="focusOnTechnician(${tech.id})"                             title="Centra sulla mappa">                        <i class="fas fa-crosshairs"></i>                    </button>                    <button class="btn btn-outline-success btn-xs"                             onclick="selectTechnicianForAssignment(${tech.id})"                            title="Seleziona per assegnazione">                        <i class="fas fa-hand-pointer"></i>                    </button>                </div>            </div>        `;    });        container.innerHTML = html;    countEl.textContent = TECHNICIANS_DATA.length;        // Setup drop zones sui tecnici    setupTechnicianDropZonesEvents();}function setupTechnicianDropZonesEvents() {    const dropZones = document.querySelectorAll('.technician-drop-zone');        dropZones.forEach(zone => {        zone.addEventListener('dragover', function(e) {            e.preventDefault();            this.classList.add('drag-over');        });                zone.addEventListener('dragleave', function(e) {            this.classList.remove('drag-over');        });                zone.addEventListener('drop', function(e) {            e.preventDefault();            this.classList.remove('drag-over');                        const techId = parseInt(this.dataset.techId);                        // Ottieni l'ordine trascinato            if (selectedOrder || draggedOrder) {                const orderId = selectedOrder?.id || draggedOrder?.id;                if (orderId && techId) {                    assignOrderToTechnician(orderId, techId);                }            }        });    });}function updateOrdersList() {    const container = document.getElementById('orders-list');    const countEl = document.getElementById('orders-count');        if (!ORDERS_DATA.length) {        container.innerHTML = `            <div class="text-center text-muted py-3">                <i class="fas fa-check-circle"></i>                <p class="mb-0">Tutti gli ordini sono assegnati!</p>            </div>        `;        countEl.textContent = '0';        return;    }        let html = '';    ORDERS_DATA.forEach(order => {        const priorityClass = `order-${order.priority.toLowerCase()}`;                html += `            <div class="draggable-order-container">                <div class="draggable-order card mb-0 ${priorityClass}" data-order-id="${order.id}" draggable="true">                    <div class="card-body p-2">                        <div class="d-flex align-items-start">                            <i class="fas fa-grip-vertical drag-handle"></i>                            <div class="flex-grow-1">                                <div class="d-flex justify-content-between align-items-start">                                    <div class="flex-grow-1">                                        <h6 class="mb-1">${order.order_number}</h6>                                        <p class="mb-1 small">${order.title}</p>                                        <small class="text-muted">${order.customer_name}</small>                                    </div>                                    <div class="text-end">                                        <span class="badge bg-${order.priority === 'URGENT' ? 'danger' : order.priority === 'HIGH' ? 'warning' : 'primary'} mb-1">                                            ${order.priority_display}                                        </span>                                    </div>                                </div>                                <div class="mt-2">                                    <button class="btn btn-outline-primary btn-xs me-1"                                             onclick="focusOnOrder('${order.id}')"                                            title="Centra sulla mappa">                                        <i class="fas fa-crosshairs"></i>                                    </button>                                    <button class="btn btn-outline-warning btn-xs"                                             onclick="selectOrderForAssignment('${order.id}')"                                            title="Seleziona per assegnazione">                                        <i class="fas fa-hand-pointer"></i>                                    </button>                                </div>                            </div>                        </div>                    </div>                </div>            </div>        `;    });        container.innerHTML = html;    countEl.textContent = ORDERS_DATA.length;        // Setup drag events sui singoli ordini    setupIndividualOrderDrag();}let draggedOrder = null;function setupIndividualOrderDrag() {    const draggableOrders = document.querySelectorAll('.draggable-order');        draggableOrders.forEach(orderElement => {        orderElement.addEventListener('dragstart', function(e) {            const orderId = this.dataset.orderId;            draggedOrder = ORDERS_DATA.find(o => o.id === orderId);                        this.classList.add('dragging');            highlightAvailableTechnicians(true);                        // Setup data transfer            e.dataTransfer.setData('text/plain', orderId);            e.dataTransfer.effectAllowed = 'move';        });                orderElement.addEventListener('dragend', function(e) {            this.classList.remove('dragging');            highlightAvailableTechnicians(false);            draggedOrder = null;        });    });}function updateStatistics() {    // Contatori    const onlineCount = TECHNICIANS_DATA.filter(t => t.is_active).length;    const workingCount = TECHNICIANS_DATA.filter(t => t.current_orders > 0).length;    const urgentCount = ORDERS_DATA.filter(o => o.priority === 'URGENT').length;    const pendingCount = ORDERS_DATA.length;    // Aggiorna elementi principali    document.getElementById('online-count').textContent = onlineCount;    document.getElementById('working-count').textContent = workingCount;    document.getElementById('urgent-count').textContent = urgentCount;    document.getElementById('pending-count').textContent = pendingCount;        // Aggiorna statistiche nel pannello se aperto    if (panelOpen) {        updatePanelStats();    }}// Funzioni di controllo mappafunction centerAllMarkers() {    const allMarkers = [];        // Aggiungi tutti i marker    techniciansLayer.eachLayer(layer => allMarkers.push(layer));    ordersLayer.eachLayer(layer => allMarkers.push(layer));        if (allMarkers.length > 0) {        const group = new L.featureGroup(allMarkers);        map.fitBounds(group.getBounds().pad(0.1));    }}function showOnlyTechnicians() {    ordersLayer.clearLayers();    loadTechnicians();    showNotification('Visualizzando solo tecnici', 'info');}function showOnlyOrders() {    techniciansLayer.clearLayers();    loadOrders();    showNotification('Visualizzando solo ordini', 'info');}function showAll() {    loadTechnicians();    loadOrders();    showNotification('Visualizzando tutto', 'info');}function toggleDragMode() {    dragModeEnabled = !dragModeEnabled;    const btn = document.getElementById('drag-mode-panel-btn');        if (dragModeEnabled) {        btn.classList.add('active');        showNotification('Modalità Drag attivata', 'info');    } else {        btn.classList.remove('active');        showNotification('Modalità Drag disattivata', 'info');    }}// Funzioni di refreshasync function refreshMapData() {    const refreshIcon = document.getElementById('refresh-icon');    refreshIcon.classList.add('fa-spin');        try {        // Chiamata API per dati aggiornati        const response = await fetch('/api/map-data/');        const data = await response.json();                // Aggiorna i dati globali        TECHNICIANS_DATA.length = 0;        TECHNICIANS_DATA.push(...data.technicians);                ORDERS_DATA.length = 0;        ORDERS_DATA.push(...data.orders);                // Ricarica markers        loadInitialData();        updateStatistics();                showNotification('Dati aggiornati con successo!', 'success');            } catch (error) {        console.error('Errore refresh:', error);        showNotification('Errore nell\'aggiornamento dati', 'danger');    } finally {        refreshIcon.classList.remove('fa-spin');    }}function toggleAutoRefresh() {    MAP_CONFIG.autoRefresh = !MAP_CONFIG.autoRefresh;    const icon = document.getElementById('auto-refresh-icon');    const text = document.getElementById('auto-refresh-text');    const indicator = document.getElementById('auto-refresh-indicator');    const panelBtn = document.getElementById('auto-refresh-panel-btn');        if (MAP_CONFIG.autoRefresh) {        icon.className = 'fas fa-pause';        text.textContent = 'Stop';        indicator.style.display = 'block';        if (panelBtn) panelBtn.classList.add('active');                MAP_CONFIG.refreshTimer = setInterval(() => {            refreshMapData();        }, MAP_CONFIG.refreshInterval);                showNotification('Auto-refresh attivato (ogni 30 secondi)', 'info');    } else {        icon.className = 'fas fa-play';        text.textContent = 'Auto';        indicator.style.display = 'none';        if (panelBtn) panelBtn.classList.remove('active');                if (MAP_CONFIG.refreshTimer) {            clearInterval(MAP_CONFIG.refreshTimer);        }                showNotification('Auto-refresh disattivato', 'warning');    }}// Funzioni di selezione e assegnazionefunction selectTechnician(technician) {    selectedTechnician = technician;    console.log('Tecnico selezionato:', technician.name);        if (selectedOrder) {        showQuickAssignModal();    }}function selectOrder(order) {    selectedOrder = order;    console.log('Ordine selezionato:', order.order_number);        if (selectedTechnician) {        showQuickAssignModal();    }}function selectTechnicianForAssignment(techId) {    const tech = TECHNICIANS_DATA.find(t => t.id === techId);    if (tech) {        selectTechnician(tech);        showNotification(`Tecnico ${tech.name} selezionato`, 'info');    }}function selectOrderForAssignment(orderId) {    const order = ORDERS_DATA.find(o => o.id === orderId);    if (order) {        selectOrder(order);        showNotification(`Ordine ${order.order_number} selezionato`, 'info');    }}function showQuickAssignModal() {    if (!selectedTechnician || !selectedOrder) return;        // Calcola distanza stimata (simulata)    const distance = calculateDistance(        selectedTechnician.lat, selectedTechnician.lng,        selectedOrder.lat, selectedOrder.lng    );        const estimatedTime = Math.round(distance * 2); // 2 min per km stimati        const content = `        <div class="row">            <div class="col-md-6">                <h6><i class="fas fa-user-cog text-success"></i> Tecnico Selezionato</h6>                <div class="card bg-light">                    <div class="card-body p-2">                        <strong>${selectedTechnician.name}</strong><br>                        <small class="text-muted">                            ${selectedTechnician.phone}<br>                            Veicolo: ${selectedTechnician.vehicle || 'N/A'}<br>                            Ordini attivi: ${selectedTechnician.current_orders}                        </small>                    </div>                </div>            </div>            <div class="col-md-6">                <h6><i class="fas fa-clipboard-list text-warning"></i> Ordine Selezionato</h6>                <div class="card bg-light">                    <div class="card-body p-2">                        <strong>${selectedOrder.order_number}</strong><br>                        <small class="text-muted">                            ${selectedOrder.customer_name}<br>                            ${selectedOrder.title}<br>                            Priorità: ${selectedOrder.priority_display}                        </small>                    </div>                </div>            </div>        </div>        <div class="route-info mt-3">            <h6><i class="fas fa-route"></i> Informazioni Percorso</h6>            <div class="row">                <div class="col-4 text-center">                    <strong>${distance.toFixed(1)} km</strong><br>                    <small>Distanza</small>                </div>                <div class="col-4 text-center">                    <strong>~${estimatedTime} min</strong><br>                    <small>Tempo stimato</small>                </div>                <div class="col-4 text-center">                    <strong>€${(distance * 0.5).toFixed(2)}</strong><br>                    <small>Costo carburante</small>                </div>            </div>        </div>    `;        document.getElementById('assign-content').innerHTML = content;        // Mostra percorso sulla mappa    showRoute(selectedTechnician, selectedOrder);        const modal = new bootstrap.Modal(document.getElementById('quickAssignModal'));    modal.show();}async function confirmAssignment() {    if (!selectedTechnician || !selectedOrder) return;        try {        await assignOrderToTechnician(selectedOrder.id, selectedTechnician.id);                // Chiudi modal        const modal = bootstrap.Modal.getInstance(document.getElementById('quickAssignModal'));        if (modal) modal.hide();                // Reset selezioni        selectedTechnician = null;        selectedOrder = null;                // Pulisci percorsi        routesLayer.clearLayers();            } catch (error) {        console.error('Errore assegnazione:', error);    }}// Funzioni di focusfunction focusOnTechnician(techId) {    const tech = TECHNICIANS_DATA.find(t => t.id === techId);    if (tech && tech.lat && tech.lng) {        map.setView([tech.lat, tech.lng], 16);                // Trova e apri popup del marker        techniciansLayer.eachLayer(layer => {            if (layer.options.technicianId === techId) {                layer.openPopup();            }        });    }}function focusOnOrder(orderId) {    const order = ORDERS_DATA.find(o => o.id === orderId);    if (order && order.lat && order.lng) {        map.setView([order.lat, order.lng], 16);                // Trova e apri popup del marker        ordersLayer.eachLayer(layer => {            if (layer.options.orderId === orderId) {                layer.openPopup();            }        });    }}// Funzioni di percorsofunction showRoute(technician, order) {    // Pulisci percorsi esistenti    routesLayer.clearLayers();        if (!technician.lat || !technician.lng || !order.lat || !order.lng) return;        // Crea polilinea semplice (in produzione usare routing API)    const route = L.polyline([        [technician.lat, technician.lng],        [order.lat, order.lng]    ], {        color: '#007bff',        weight: 4,        opacity: 0.7,        dashArray: '10, 10'    });        routesLayer.addLayer(route);        // Centra la mappa sul percorso    map.fitBounds(route.getBounds().pad(0.1));}function optimizeRoutes() {    showNotification('Ottimizzazione percorsi in sviluppo!', 'info');}// Funzioni di azionefunction showAssignModal() {    window.location.href = '/orders/create/';}function exportMapData() {    const data = {        technicians: TECHNICIANS_DATA,        orders: ORDERS_DATA,        timestamp: new Date().toISOString()    };        const blob = new Blob([JSON.stringify(data, null, 2)], {        type: 'application/json'    });        const url = URL.createObjectURL(blob);    const a = document.createElement('a');    a.href = url;    a.download = `map_data_${new Date().toISOString().split('T')[0]}.json`;    a.click();    URL.revokeObjectURL(url);        showNotification('Dati esportati con successo!', 'success');}// Funzioni dettagli (placeholder)function showTechnicianDetails(techId) {    showNotification('Dettagli tecnico in sviluppo!', 'info');}function showOrderDetails(orderId) {    showNotification('Dettagli ordine in sviluppo!', 'info');}// Funzioni di utilitàfunction calculateDistance(lat1, lng1, lat2, lng2) {    const R = 6371; // Raggio Terra in km    const dLat = (lat2 - lat1) * Math.PI / 180;    const dLng = (lng2 - lng1) * Math.PI / 180;    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *              Math.sin(dLng/2) * Math.sin(dLng/2);    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));    return R * c;}function formatDate(dateString) {    if (!dateString) return 'N/A';        const date = new Date(dateString);    return date.toLocaleString('it-IT', {        day: '2-digit',        month: '2-digit',        year: 'numeric',        hour: '2-digit',        minute: '2-digit'    });}function showNotification(message, type = 'info') {    // Crea elemento notifica    const notification = document.createElement('div');    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;    notification.style.cssText = `        top: 20px;        right: 20px;        z-index: 9999;        min-width: 300px;        box-shadow: 0 4px 8px rgba(0,0,0,0.1);    `;    notification.innerHTML = `        ${message}        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>    `;        document.body.appendChild(notification);        // Rimuovi automaticamente dopo 3 secondi    setTimeout(() => {        if (notification.parentNode) {            notification.remove();        }    }, 3000);}function getCSRFToken() {    const name = 'csrftoken';    let cookieValue = null;    if (document.cookie && document.cookie !== '') {        const cookies = document.cookie.split(';');        for (let i = 0; i < cookies.length; i++) {            const cookie = cookies[i].trim();            if (cookie.substring(0, name.length + 1) === (name + '=')) {                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));                break;            }        }    }    return cookieValue;}// Gestione errori JavaScriptwindow.addEventListener('error', function(e) {    console.error('Errore JavaScript:', e.error);    showNotification('Errore nell\'applicazione. Ricarica la pagina.', 'danger');});// Cleanup quando si esce dalla paginawindow.addEventListener('beforeunload', function() {    if (MAP_CONFIG.refreshTimer) {        clearInterval(MAP_CONFIG.refreshTimer);    }});</script>{% endblock %}